"use strict";function fetchAttachmentsIfNecessary(e,t,n,r,i){function s(){++o===a.length&&i&&i()}function u(e,i){var a=e._attachments[i],o={binary:t.binary,ctx:r};n._getAttachment(a,o,function(t,n){e._attachments[i]=utils.extend(utils.pick(a,["digest","content_type"]),{data:n}),s()})}var a=Object.keys(e._attachments||{});if(!a.length)return i&&i();var o=0;a.forEach(function(n){t.attachments&&t.include_docs?u(e,n):(e._attachments[n].stub=!0,s())})}function WebSqlPouch(e,t){function u(){hasLocalStorage()&&(window.localStorage["_pouch__websqldb_"+n._name]=!0),t(null,n)}function c(e,t){e.executeSql(DOC_STORE_WINNINGSEQ_INDEX_SQL),e.executeSql("ALTER TABLE "+BY_SEQ_STORE+" ADD COLUMN deleted TINYINT(1) DEFAULT 0",[],function(){e.executeSql(BY_SEQ_STORE_DELETED_INDEX_SQL),e.executeSql("ALTER TABLE "+DOC_STORE+" ADD COLUMN local TINYINT(1) DEFAULT 0",[],function(){e.executeSql("CREATE INDEX IF NOT EXISTS 'doc-store-local-idx' ON "+DOC_STORE+" (local, id)");var n="SELECT "+DOC_STORE+".winningseq AS seq, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq";e.executeSql(n,[],function(e,n){for(var r=[],i=[],a=0;a<n.rows.length;a++){var o=n.rows.item(a),s=o.seq,u=JSON.parse(o.metadata);isDeleted(u)&&r.push(s),isLocalId(u.id)&&i.push(u.id)}e.executeSql("UPDATE "+DOC_STORE+"SET local = 1 WHERE id IN "+qMarks(i.length),i,function(){e.executeSql("UPDATE "+BY_SEQ_STORE+" SET deleted = 1 WHERE seq IN "+qMarks(r.length),r,t)})})})})}function l(e,t){var n="CREATE TABLE IF NOT EXISTS "+LOCAL_STORE+" (id UNIQUE, rev, json)";e.executeSql(n,[],function(){var n="SELECT "+DOC_STORE+".id AS id, "+BY_SEQ_STORE+".json AS data FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq WHERE local = 1";e.executeSql(n,[],function(e,n){function a(){if(!r.length)return t(e);var n=r.shift(),i=JSON.parse(n.data)._rev;e.executeSql("INSERT INTO "+LOCAL_STORE+" (id, rev, json) VALUES (?,?,?)",[n.id,i,n.data],function(e){e.executeSql("DELETE FROM "+DOC_STORE+" WHERE id=?",[n.id],function(e){e.executeSql("DELETE FROM "+BY_SEQ_STORE+" WHERE seq=?",[n.seq],function(){a()})})})}for(var r=[],i=0;i<n.rows.length;i++)r.push(n.rows.item(i));a()})})}function f(e,t){function n(n){function r(){if(!n.length)return t(e);var i=n.shift(),a=parseHexString(i.hex,o),s=a.lastIndexOf("::"),u=a.substring(0,s),c=a.substring(s+2),l="UPDATE "+BY_SEQ_STORE+" SET doc_id=?, rev=? WHERE doc_id_rev=?";e.executeSql(l,[u,c,a],function(){r()})}r()}var r="ALTER TABLE "+BY_SEQ_STORE+" ADD COLUMN doc_id";e.executeSql(r,[],function(e){var t="ALTER TABLE "+BY_SEQ_STORE+" ADD COLUMN rev";e.executeSql(t,[],function(e){e.executeSql(BY_SEQ_STORE_DOC_ID_REV_INDEX_SQL,[],function(e){var t="SELECT hex(doc_id_rev) as hex FROM "+BY_SEQ_STORE;e.executeSql(t,[],function(e,t){for(var r=[],i=0;i<t.rows.length;i++)r.push(t.rows.item(i));n(r)})})})})}function d(e,t){function n(e){var n="SELECT COUNT(*) AS cnt FROM "+ATTACH_STORE;e.executeSql(n,[],function(e,n){function o(){var n=select(SELECT_DOCS+", "+DOC_STORE+".id AS id",[DOC_STORE,BY_SEQ_STORE],DOC_STORE_AND_BY_SEQ_JOINER,null,DOC_STORE+".id ");n+=" LIMIT "+a+" OFFSET "+i,i+=a,e.executeSql(n,[],function(e,n){function i(e,t){var n=r[e]=r[e]||[];-1===n.indexOf(t)&&n.push(t)}if(!n.rows.length)return t(e);for(var r={},a=0;a<n.rows.length;a++)for(var s=n.rows.item(a),u=unstringifyDoc(s.data,s.id,s.rev),c=Object.keys(u._attachments||{}),l=0;l<c.length;l++){var f=u._attachments[c[l]];i(f.digest,s.seq)}var d=[];if(Object.keys(r).forEach(function(e){var t=r[e];t.forEach(function(t){d.push([e,t])})}),!d.length)return o();var p=0;d.forEach(function(t){var n="INSERT INTO "+ATTACH_AND_SEQ_STORE+" (digest, seq) VALUES (?,?)";e.executeSql(n,t,function(){++p===d.length&&o()})})})}var r=n.rows.item(0).cnt;if(!r)return t(e);var i=0,a=10;o()})}var r="CREATE TABLE IF NOT EXISTS "+ATTACH_AND_SEQ_STORE+" (digest, seq INTEGER)";e.executeSql(r,[],function(e){e.executeSql(ATTACH_AND_SEQ_STORE_ATTACH_INDEX_SQL,[],function(e){e.executeSql(ATTACH_AND_SEQ_STORE_SEQ_INDEX_SQL,[],n)})})}function p(e,t){var n="ALTER TABLE "+ATTACH_STORE+" ADD COLUMN escaped TINYINT(1) DEFAULT 0";e.executeSql(n,[],t)}function h(e,t){var n="ALTER TABLE "+DOC_STORE+" ADD COLUMN max_seq INTEGER";e.executeSql(n,[],function(e){var n="UPDATE "+DOC_STORE+" SET max_seq=(SELECT MAX(seq) FROM "+BY_SEQ_STORE+" WHERE doc_id=id)";e.executeSql(n,[],function(e){var n="CREATE UNIQUE INDEX IF NOT EXISTS 'doc-max-seq-idx' ON "+DOC_STORE+" (max_seq)";e.executeSql(n,[],t)})})}function m(e,t){e.executeSql('SELECT HEX("a") AS hex',[],function(e,n){var r=n.rows.item(0).hex;o=2===r.length?"UTF-8":"UTF-16",t()})}function v(){for(;a.length>0;){var e=a.pop();e(null,r)}}function g(e,t){if(0===t){var n="CREATE TABLE IF NOT EXISTS "+META_STORE+" (dbid, db_version INTEGER)",i="CREATE TABLE IF NOT EXISTS "+ATTACH_STORE+" (digest UNIQUE, escaped TINYINT(1), body BLOB)",a="CREATE TABLE IF NOT EXISTS "+ATTACH_AND_SEQ_STORE+" (digest, seq INTEGER)",o="CREATE TABLE IF NOT EXISTS "+DOC_STORE+" (id unique, json, winningseq, max_seq INTEGER UNIQUE)",s="CREATE TABLE IF NOT EXISTS "+BY_SEQ_STORE+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, json, deleted TINYINT(1), doc_id, rev)",u="CREATE TABLE IF NOT EXISTS "+LOCAL_STORE+" (id UNIQUE, rev, json)";e.executeSql(i),e.executeSql(u),e.executeSql(a,[],function(){e.executeSql(ATTACH_AND_SEQ_STORE_SEQ_INDEX_SQL),e.executeSql(ATTACH_AND_SEQ_STORE_ATTACH_INDEX_SQL)}),e.executeSql(o,[],function(){e.executeSql(DOC_STORE_WINNINGSEQ_INDEX_SQL),e.executeSql(s,[],function(){e.executeSql(BY_SEQ_STORE_DELETED_INDEX_SQL),e.executeSql(BY_SEQ_STORE_DOC_ID_REV_INDEX_SQL),e.executeSql(n,[],function(){var t="INSERT INTO "+META_STORE+" (db_version, dbid) VALUES (?,?)";r=utils.uuid();var n=[ADAPTER_VERSION,r];e.executeSql(t,n,function(){v()})})})})}else{var m=function(){var n=ADAPTER_VERSION>t;n&&e.executeSql("UPDATE "+META_STORE+" SET db_version = "+ADAPTER_VERSION);var i="SELECT dbid FROM "+META_STORE;e.executeSql(i,[],function(e,t){r=t.rows.item(0).dbid,v()})},g=[c,l,f,d,p,h,m],b=t,y=function(e){g[b-1](e,y),b++};y(e)}}function b(){s.transaction(function(e){m(e,function(){y(e)})},unknownError(t),u)}function y(e){var t="SELECT sql FROM sqlite_master WHERE tbl_name = "+META_STORE;e.executeSql(t,[],function(e,t){t.rows.length?/db_version/.test(t.rows.item(0).sql)?e.executeSql("SELECT db_version FROM "+META_STORE,[],function(e,t){var n=t.rows.item(0).db_version;g(e,n)}):e.executeSql("ALTER TABLE "+META_STORE+" ADD COLUMN db_version INTEGER",[],function(){g(e,1)}):g(e,0)})}function A(e,t){if(-1!==n._docCount)return t(n._docCount);var r=select("COUNT("+DOC_STORE+".id) AS 'num'",[DOC_STORE,BY_SEQ_STORE],DOC_STORE_AND_BY_SEQ_JOINER,BY_SEQ_STORE+".deleted=0");e.executeSql(r,[],function(e,r){n._docCount=r.rows.item(0).num,t(n._docCount)})}var o,n=this,r=null,i=getSize(e),a=[];n._docCount=-1,n._name=e.name;var s=openDB({name:n._name,version:POUCH_VERSION,description:n._name,size:i,location:e.location,createFromLocation:e.createFromLocation,androidDatabaseImplementation:e.androidDatabaseImplementation});return s?("function"!=typeof s.readTransaction&&(s.readTransaction=s.transaction),utils.isCordova()?window.addEventListener(n._name+"_pouch",function E(){window.removeEventListener(n._name+"_pouch",E,!1),b()},!1):b(),n.type=function(){return"websql"},n._id=utils.toPromise(function(e){e(null,r)}),n._info=function(e){s.readTransaction(function(t){A(t,function(n){var r="SELECT MAX(seq) AS seq FROM "+BY_SEQ_STORE;t.executeSql(r,[],function(t,r){var i=r.rows.item(0).seq||0;e(null,{doc_count:n,update_seq:i,sqlite_plugin:s._sqlitePlugin,websql_encoding:o})})})},unknownError(e))},n._bulkDocs=function(e,t,r){websqlBulkDocs(e,t,n,s,WebSqlPouch.Changes,r)},n._get=function(e,t,r){function c(){r(o,{doc:i,metadata:a,ctx:u})}t=utils.clone(t);var i,a,o;if(!t.ctx)return void s.readTransaction(function(i){t.ctx=i,n._get(e,t,r)});var l,f,u=t.ctx;t.rev?(l=select(SELECT_DOCS,[DOC_STORE,BY_SEQ_STORE],DOC_STORE+".id="+BY_SEQ_STORE+".doc_id",[BY_SEQ_STORE+".doc_id=?",BY_SEQ_STORE+".rev=?"]),f=[e,t.rev]):(l=select(SELECT_DOCS,[DOC_STORE,BY_SEQ_STORE],DOC_STORE_AND_BY_SEQ_JOINER,DOC_STORE+".id=?"),f=[e]),u.executeSql(l,f,function(e,n){if(!n.rows.length)return o=errors.error(errors.MISSING_DOC,"missing"),c();var r=n.rows.item(0);return a=utils.safeJsonParse(r.metadata),r.deleted&&!t.rev?(o=errors.error(errors.MISSING_DOC,"deleted"),c()):(i=unstringifyDoc(r.data,a.id,r.rev),void c())})},n._allDocs=function(e,t){var i,r=[],a="startkey"in e?e.startkey:!1,o="endkey"in e?e.endkey:!1,u="key"in e?e.key:!1,c="descending"in e?e.descending:!1,l="limit"in e?e.limit:-1,f="skip"in e?e.skip:0,d=e.inclusive_end!==!1,p=[],h=[];if(u!==!1)h.push(DOC_STORE+".id = ?"),p.push(u);else if(a!==!1||o!==!1){if(a!==!1&&(h.push(DOC_STORE+".id "+(c?"<=":">=")+" ?"),p.push(a)),o!==!1){var m=c?">":"<";d&&(m+="="),h.push(DOC_STORE+".id "+m+" ?"),p.push(o)}u!==!1&&(h.push(DOC_STORE+".id = ?"),p.push(u))}"ok"!==e.deleted&&h.push(BY_SEQ_STORE+".deleted = 0"),s.readTransaction(function(t){A(t,function(a){if(i=a,0!==l){var o=select(SELECT_DOCS,[DOC_STORE,BY_SEQ_STORE],DOC_STORE_AND_BY_SEQ_JOINER,h,DOC_STORE+".id "+(c?"DESC":"ASC"));o+=" LIMIT "+l+" OFFSET "+f,t.executeSql(o,p,function(t,i){for(var a=0,o=i.rows.length;o>a;a++){var s=i.rows.item(a),u=utils.safeJsonParse(s.metadata),c=u.id,l=unstringifyDoc(s.data,c,s.rev),f=l._rev,d={id:c,key:c,value:{rev:f}};if(e.include_docs&&(d.doc=l,d.doc._rev=f,e.conflicts&&(d.doc._conflicts=merge.collectConflicts(u)),fetchAttachmentsIfNecessary(d.doc,e,n,t)),s.deleted){if("ok"!==e.deleted)continue;d.value.deleted=!0,d.doc=null}r.push(d)}})}})},unknownError(t),function(){t(null,{total_rows:i,offset:e.skip,rows:r})})},n._changes=function(e){function c(){var t=DOC_STORE+".json AS metadata, "+DOC_STORE+".max_seq AS maxSeq, "+BY_SEQ_STORE+".json AS winningDoc, "+BY_SEQ_STORE+".rev AS winningRev ",c=DOC_STORE+" JOIN "+BY_SEQ_STORE,l=DOC_STORE+".id="+BY_SEQ_STORE+".doc_id AND "+DOC_STORE+".winningseq="+BY_SEQ_STORE+".seq",f=["maxSeq > ?"],d=[e.since];e.doc_ids&&(f.push(DOC_STORE+".id IN "+qMarks(e.doc_ids.length)),d=d.concat(e.doc_ids));var p="maxSeq "+(r?"DESC":"ASC"),h=select(t,c,l,f,p),m=utils.filterChange(e);e.view||e.filter||(h+=" LIMIT "+i);var v=e.since||0;s.readTransaction(function(t){t.executeSql(h,d,function(t,r){function s(t){return function(){e.onChange(t)}}for(var c=0,l=r.rows.length;l>c;c++){var f=r.rows.item(c),d=utils.safeJsonParse(f.metadata);v=f.maxSeq;var p=unstringifyDoc(f.winningDoc,d.id,f.winningRev),h=e.processChange(p,d,e);if(h.seq=f.maxSeq,m(h)&&(u++,a&&o.push(h),e.attachments&&e.include_docs?fetchAttachmentsIfNecessary(p,e,n,t,s(h)):s(h)()),u===i)break}})},unknownError(e.complete),function(){e.continuous||e.complete(null,{results:o,last_seq:v})})}if(e=utils.clone(e),e.continuous){var t=n._name+":"+utils.uuid();return WebSqlPouch.Changes.addListener(n._name,t,n,e),WebSqlPouch.Changes.notify(n._name),{cancel:function(){WebSqlPouch.Changes.removeListener(n._name,t)}}}var r=e.descending;e.since=e.since&&!r?e.since:0;var i="limit"in e?e.limit:-1;0===i&&(i=1);var a;a="returnDocs"in e?e.returnDocs:!0;var o=[],u=0;c()},n._close=function(e){e()},n._getAttachment=function(e,t,n){var r,i=t.ctx,a=e.digest,s=e.content_type,u="SELECT escaped, CASE WHEN escaped = 1 THEN body ELSE HEX(body) END AS body FROM "+ATTACH_STORE+" WHERE digest=?";i.executeSql(u,[a],function(e,i){var a=i.rows.item(0),u=a.escaped?websqlUtils.unescapeBlob(a.body):parseHexString(a.body,o);r=t.binary?binStringToBlob(u,s):utils.btoa(u),n(null,r)})},n._getRevisionTree=function(e,t){s.readTransaction(function(n){var r="SELECT json AS metadata FROM "+DOC_STORE+" WHERE id = ?";n.executeSql(r,[e],function(e,n){if(n.rows.length){var r=utils.safeJsonParse(n.rows.item(0).metadata);t(null,r.rev_tree)}else t(errors.error(errors.MISSING_DOC))})})},n._doCompaction=function(e,t,n){return t.length?void s.transaction(function(n){var r="SELECT json AS metadata FROM "+DOC_STORE+" WHERE id = ?";n.executeSql(r,[e],function(n,r){var i=utils.safeJsonParse(r.rows.item(0).metadata);merge.traverseRevTree(i.rev_tree,function(e,n,r,i,a){var o=n+"-"+r;-1!==t.indexOf(o)&&(a.status="missing")});var a="UPDATE "+DOC_STORE+" SET json = ? WHERE id = ?";n.executeSql(a,[utils.safeJsonStringify(i),e])}),compactRevs(t,e,n)},unknownError(n),function(){n()}):n()},n._getLocal=function(e,t){s.readTransaction(function(n){var r="SELECT json, rev FROM "+LOCAL_STORE+" WHERE id=?";n.executeSql(r,[e],function(n,r){if(r.rows.length){var i=r.rows.item(0),a=unstringifyDoc(i.json,e,i.rev);t(null,a)}else t(errors.error(errors.MISSING_DOC))})})},n._putLocal=function(e,t,n){function c(e){var s,c;r?(s="UPDATE "+LOCAL_STORE+" SET rev=?, json=? WHERE id=? AND rev=?",c=[a,o,i,r]):(s="INSERT INTO "+LOCAL_STORE+" (id, rev, json) VALUES (?,?,?)",c=[i,a,o]),e.executeSql(s,c,function(e,r){r.rowsAffected?(u={ok:!0,id:i,rev:a},t.ctx&&n(null,u)):n(errors.error(errors.REV_CONFLICT))},function(){return n(errors.error(errors.REV_CONFLICT)),!1})}"function"==typeof t&&(n=t,t={}),delete e._revisions;var a,r=e._rev,i=e._id;a=r?e._rev="0-"+(parseInt(r.split("-")[1],10)+1):e._rev="0-1";var u,o=stringifyDoc(e);t.ctx?c(t.ctx):s.transaction(c,unknownError(n),function(){u&&n(null,u)})},n._removeLocal=function(e,t,n){function i(i){var a="DELETE FROM "+LOCAL_STORE+" WHERE id=? AND rev=?",o=[e._id,e._rev];i.executeSql(a,o,function(i,a){return a.rowsAffected?(r={ok:!0,id:e._id,rev:"0-0"},void(t.ctx&&n(null,r))):n(errors.error(errors.MISSING_DOC))})}"function"==typeof t&&(n=t,t={});var r;t.ctx?i(t.ctx):s.transaction(i,unknownError(n),function(){r&&n(null,r)})},void(n._destroy=function(e){WebSqlPouch.Changes.removeAllListeners(n._name),s.transaction(function(e){var t=[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,META_STORE,LOCAL_STORE,ATTACH_AND_SEQ_STORE];t.forEach(function(t){e.executeSql("DROP TABLE IF EXISTS "+t,[])})},unknownError(e),function(){hasLocalStorage()&&(delete window.localStorage["_pouch__websqldb_"+n._name],delete window.localStorage[n._name]),e(null,{ok:!0})})})):t(errors.error(errors.UNKNOWN_ERROR))}var utils=require("../../utils"),merge=require("../../merge"),isDeleted=require("../../deps/docs/isDeleted"),isLocalId=require("../../deps/docs/isLocalId"),errors=require("../../deps/errors"),parseHexString=require("../../deps/parseHex"),binStringToBlob=require("../../deps/binary/binaryStringToBlobOrBuffer"),hasLocalStorage=require("../../deps/env/hasLocalStorage"),websqlConstants=require("./constants"),websqlUtils=require("./utils"),websqlBulkDocs=require("./bulkDocs"),ADAPTER_VERSION=websqlConstants.ADAPTER_VERSION,DOC_STORE=websqlConstants.DOC_STORE,BY_SEQ_STORE=websqlConstants.BY_SEQ_STORE,ATTACH_STORE=websqlConstants.ATTACH_STORE,LOCAL_STORE=websqlConstants.LOCAL_STORE,META_STORE=websqlConstants.META_STORE,ATTACH_AND_SEQ_STORE=websqlConstants.ATTACH_AND_SEQ_STORE,qMarks=websqlUtils.qMarks,stringifyDoc=websqlUtils.stringifyDoc,unstringifyDoc=websqlUtils.unstringifyDoc,select=websqlUtils.select,compactRevs=websqlUtils.compactRevs,unknownError=websqlUtils.unknownError,getSize=websqlUtils.getSize,openDB=websqlUtils.openDB,POUCH_VERSION=1,BY_SEQ_STORE_DELETED_INDEX_SQL="CREATE INDEX IF NOT EXISTS 'by-seq-deleted-idx' ON "+BY_SEQ_STORE+" (seq, deleted)",BY_SEQ_STORE_DOC_ID_REV_INDEX_SQL="CREATE UNIQUE INDEX IF NOT EXISTS 'by-seq-doc-id-rev' ON "+BY_SEQ_STORE+" (doc_id, rev)",DOC_STORE_WINNINGSEQ_INDEX_SQL="CREATE INDEX IF NOT EXISTS 'doc-winningseq-idx' ON "+DOC_STORE+" (winningseq)",ATTACH_AND_SEQ_STORE_SEQ_INDEX_SQL="CREATE INDEX IF NOT EXISTS 'attach-seq-seq-idx' ON "+ATTACH_AND_SEQ_STORE+" (seq)",ATTACH_AND_SEQ_STORE_ATTACH_INDEX_SQL="CREATE UNIQUE INDEX IF NOT EXISTS 'attach-seq-digest-idx' ON "+ATTACH_AND_SEQ_STORE+" (digest, seq)",DOC_STORE_AND_BY_SEQ_JOINER=BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq",SELECT_DOCS=BY_SEQ_STORE+".seq AS seq, "+BY_SEQ_STORE+".deleted AS deleted, "+BY_SEQ_STORE+".json AS data, "+BY_SEQ_STORE+".rev AS rev, "+DOC_STORE+".json AS metadata";WebSqlPouch.valid=websqlUtils.valid,WebSqlPouch.Changes=new utils.Changes,module.exports=WebSqlPouch;
