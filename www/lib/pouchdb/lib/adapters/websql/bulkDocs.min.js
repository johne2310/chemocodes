"use strict";function websqlBulkDocs(e,t,n,r,i,a){function h(){return p?a(p):(i.notify(n._name),n._docCount=-1,void a(null,f))}function m(e,t){var n="SELECT count(*) as cnt FROM "+ATTACH_STORE+" WHERE digest=?";l.executeSql(n,[e],function(n,r){if(0===r.rows.item(0).cnt){var i=errors.error(errors.MISSING_STUB,"unknown stub attachment with digest "+e);t(i)}else t()})}function v(e){function i(){++n===t.length&&e(r)}var t=[];if(u.forEach(function(e){e.data&&e.data._attachments&&Object.keys(e.data._attachments).forEach(function(n){var r=e.data._attachments[n];r.stub&&t.push(r.digest)})}),!t.length)return e();var r,n=0;t.forEach(function(e){m(e,function(e){e&&!r&&(r=e),i()})})}function g(e,t,r,i,a,o,s,u){function c(){function c(e,n){function a(){return++r===i.length&&n(),!1}function o(n){var r="INSERT INTO "+ATTACH_AND_SEQ_STORE+" (digest, seq) VALUES (?,?)",i=[t._attachments[n].digest,e];l.executeSql(r,i,a,a)}var r=0,i=Object.keys(t._attachments||{});if(!i.length)return n();for(var s=0;s<i.length;s++)o(i[s])}var t=e.data,n=i?1:0,r=t._id,a=t._rev,o=stringifyDoc(t),s="INSERT INTO "+BY_SEQ_STORE+" (doc_id, rev, json, deleted) VALUES (?, ?, ?, ?);",u=[r,a,o,n];l.executeSql(s,u,function(e,t){var n=t.insertId;c(n,function(){y(e,n)})},function(){var e=select("seq",BY_SEQ_STORE,null,"doc_id=? AND rev=?");return l.executeSql(e,[r,a],function(e,t){var i=t.rows.item(0).seq,s="UPDATE "+BY_SEQ_STORE+" SET json=?, deleted=? WHERE doc_id=? AND rev=?;",u=[o,n,r,a];e.executeSql(s,u,function(e){c(i,function(){y(e,i)})})}),!1})}function p(e){h||(e?(h=e,u(h)):m===v.length&&c())}function g(e){m++,p(e)}function b(){if(a&&n.auto_compaction){var t=e.metadata.id,r=utils.compactTree(e.metadata);compactRevs(r,t,l)}}function y(n,r){b(),e.metadata.seq=r,delete e.metadata.rev;var i=a?"UPDATE "+DOC_STORE+" SET json=?, max_seq=?, winningseq=(SELECT seq FROM "+BY_SEQ_STORE+" WHERE doc_id="+DOC_STORE+".id AND rev=?) WHERE id=?":"INSERT INTO "+DOC_STORE+" (id, winningseq, max_seq, json) VALUES (?,?,?,?);",o=utils.safeJsonStringify(e.metadata),c=e.metadata.id,l=a?[o,r,t,c]:[c,r,r,o];n.executeSql(i,l,function(){f[s]={ok:!0,id:e.metadata.id,rev:t},d.set(c,e.metadata),u()})}var h=null,m=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev;var v=Object.keys(e.data._attachments||{});i&&(e.data._deleted=!0),v.forEach(function(t){var n=e.data._attachments[t];if(n.stub)m++,p();else{var r=n.data;delete n.data;var i=n.digest;A(i,r,g)}}),v.length||c()}function b(){processDocs(u,n,d,l,f,g,t)}function y(e){function n(){++t===u.length&&e()}if(!u.length)return e();var t=0;u.forEach(function(e){if(e._id&&isLocalId(e._id))return n();var t=e.metadata.id;l.executeSql("SELECT json FROM "+DOC_STORE+" WHERE id = ?",[t],function(e,r){if(r.rows.length){var i=utils.safeJsonParse(r.rows.item(0).json);d.set(t,i)}n()})})}function A(e,t,n){var r="SELECT digest FROM "+ATTACH_STORE+" WHERE digest=?";l.executeSql(r,[e],function(i,a){return a.rows.length?n():(r="INSERT INTO "+ATTACH_STORE+" (digest, body, escaped) VALUES (?,?,1)",void i.executeSql(r,[e,websqlUtils.escapeBlob(t)],function(){n()},function(){return n(),!1}))})}var o=t.new_edits,s=e.docs,u=s.map(function(e){if(e._id&&isLocalId(e._id))return e;var t=utils.parseDoc(e,o);return t}),c=u.filter(function(e){return e.error});if(c.length)return a(c[0]);var l,p,f=new Array(u.length),d=new utils.Map;preprocessAttachments(u,"binary",function(e){return e?a(e):void r.transaction(function(e){l=e,v(function(e){e?p=e:y(b)})},unknownError(a),h)})}var utils=require("../../utils"),errors=require("../../deps/errors"),preprocessAttachments=require("../../deps/docs/preprocessAttachments"),isLocalId=require("../../deps/docs/isLocalId"),processDocs=require("../../deps/docs/processDocs"),websqlUtils=require("./utils"),websqlConstants=require("./constants"),DOC_STORE=websqlConstants.DOC_STORE,BY_SEQ_STORE=websqlConstants.BY_SEQ_STORE,ATTACH_STORE=websqlConstants.ATTACH_STORE,ATTACH_AND_SEQ_STORE=websqlConstants.ATTACH_AND_SEQ_STORE,select=websqlUtils.select,stringifyDoc=websqlUtils.stringifyDoc,compactRevs=websqlUtils.compactRevs,unknownError=websqlUtils.unknownError;module.exports=websqlBulkDocs;
