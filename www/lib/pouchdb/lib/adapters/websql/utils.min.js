"use strict";function escapeBlob(e){return e.replace(/\u0002/g,"").replace(/\u0001/g,"").replace(/\u0000/g,"")}function unescapeBlob(e){return e.replace(/\u0001\u0001/g,"\x00").replace(/\u0001\u0002/g,"").replace(/\u0002\u0002/g,"")}function stringifyDoc(e){return delete e._id,delete e._rev,JSON.stringify(e)}function unstringifyDoc(e,t,n){return e=JSON.parse(e),e._id=t,e._rev=n,e}function qMarks(e){for(var t="(";e--;)t+="?",e&&(t+=",");return t+")"}function select(e,t,n,r,i){return"SELECT "+e+" FROM "+("string"==typeof t?t:t.join(" JOIN "))+(n?" ON "+n:"")+(r?" WHERE "+("string"==typeof r?r:r.join(" AND ")):"")+(i?" ORDER BY "+i:"")}function compactRevs(e,t,n){function a(){++r===e.length&&o()}function o(){if(i.length){var e="SELECT DISTINCT digest AS digest FROM "+ATTACH_AND_SEQ_STORE+" WHERE seq IN "+qMarks(i.length);n.executeSql(e,i,function(e,t){for(var n=[],r=0;r<t.rows.length;r++)n.push(t.rows.item(r).digest);if(n.length){var a="DELETE FROM "+ATTACH_AND_SEQ_STORE+" WHERE seq IN ("+i.map(function(){return"?"}).join(",")+")";e.executeSql(a,i,function(e){var t="SELECT digest FROM "+ATTACH_AND_SEQ_STORE+" WHERE digest IN ("+n.map(function(){return"?"}).join(",")+")";e.executeSql(t,n,function(e,t){for(var r=new utils.Set,i=0;i<t.rows.length;i++)r.add(t.rows.item(i).digest);n.forEach(function(t){r.has(t)||(e.executeSql("DELETE FROM "+ATTACH_AND_SEQ_STORE+" WHERE digest=?",[t]),e.executeSql("DELETE FROM "+ATTACH_STORE+" WHERE digest=?",[t]))})})})}})}}if(e.length){var r=0,i=[];e.forEach(function(e){var r="SELECT seq FROM "+BY_SEQ_STORE+" WHERE doc_id=? AND rev=?";n.executeSql(r,[t,e],function(e,t){if(!t.rows.length)return a();var n=t.rows.item(0).seq;i.push(n),e.executeSql("DELETE FROM "+BY_SEQ_STORE+" WHERE seq=?",[n],a)})})}}function unknownError(e){return function(t){var n=t&&t.constructor.toString().match(/function ([^\(]+)/),r=n&&n[1]||t.type,i=t.target||t.message;e(errors.error(errors.WSQ_ERROR,i,r))}}function getSize(e){if("size"in e)return 1e6*e.size;var t=/Android/.test(window.navigator.userAgent);return t?5e6:1}function createOpenDBFunction(){return"undefined"!=typeof sqlitePlugin?sqlitePlugin.openDatabase.bind(sqlitePlugin):"undefined"!=typeof openDatabase?function(e){return openDatabase(e.name,e.version,e.description,e.size)}:void 0}function openDB(e){var t=createOpenDBFunction(),n=cachedDatabases[e.name];return n||(n=cachedDatabases[e.name]=t(e),n._sqlitePlugin="undefined"!=typeof sqlitePlugin),n}function valid(){return"undefined"!=typeof openDatabase||"undefined"!=typeof SQLitePlugin}var utils=require("../../utils"),errors=require("../../deps/errors"),websqlConstants=require("./constants"),BY_SEQ_STORE=websqlConstants.BY_SEQ_STORE,ATTACH_STORE=websqlConstants.ATTACH_STORE,ATTACH_AND_SEQ_STORE=websqlConstants.ATTACH_AND_SEQ_STORE,cachedDatabases={};module.exports={escapeBlob:escapeBlob,unescapeBlob:unescapeBlob,stringifyDoc:stringifyDoc,unstringifyDoc:unstringifyDoc,qMarks:qMarks,select:select,compactRevs:compactRevs,unknownError:unknownError,getSize:getSize,openDB:openDB,valid:valid};
