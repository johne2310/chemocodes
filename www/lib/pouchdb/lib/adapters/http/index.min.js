"use strict";function readAttachmentsAsBlobOrBuffer(e){var t=e.doc&&e.doc._attachments;t&&Object.keys(t).forEach(function(e){var n=t[e];n.data=b64StringToBluffer(n.data,n.content_type)})}function encodeDocId(e){return/^_design/.test(e)?"_design/"+encodeURIComponent(e.slice(8)):/^_local/.test(e)?"_local/"+encodeURIComponent(e.slice(7)):encodeURIComponent(e)}function preprocessAttachments(e){return e._attachments&&Object.keys(e._attachments)?Promise.all(Object.keys(e._attachments).map(function(t){var n=e._attachments[t];return n.data&&"string"!=typeof n.data?blufferToBase64(n.data).then(function(e){n.data=e}):void 0})):Promise.resolve()}function getHost(e,t){var n=utils.parseUri(e);(n.user||n.password)&&(n.auth={username:n.user,password:n.password});var r=n.path.replace(/(^\/|\/$)/g,"").split("/");if(n.db=r.pop(),n.path=r.join("/"),t=t||{},t=clone(t),n.headers=t.headers||t.ajax&&t.ajax.headers||{},t.auth||n.auth){var i=t.auth||n.auth,a=btoa(i.username+":"+i.password);n.headers.Authorization="Basic "+a}return t.headers&&(n.headers=t.headers),n}function genDBUrl(e,t){return genUrl(e,e.db+"/"+t)}function genUrl(e,t){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+t}function HttpPouch(e,t){function s(e,t){var n=utils.extend(!0,clone(o),e);return log(n.method+" "+n.url),utils.ajax(n,t)}function u(e){return new Promise(function(t,n){s(e,function(e,r){return e?n(e):void t(r)})})}function l(e){return e.split("/").map(encodeURIComponent).join("/")}var n=this,r=getHost;e.getHost&&(r=e.getHost);var i=r(e.name,e),a=genDBUrl(i,"");n.getUrl=function(){return a},n.getHeaders=function(){return clone(i.headers)};var o=e.ajax||{};e=clone(e);var c=function(){s({headers:clone(i.headers),method:"PUT",url:a},function(e){e&&401===e.status?s({headers:clone(i.headers),method:"HEAD",url:a},function(e){e?t(e):t(null,n)}):e&&412!==e.status?t(e):t(null,n)})};e.skipSetup||s({headers:clone(i.headers),method:"GET",url:a},function(e){e?404===e.status?(utils.explain404("PouchDB is just detecting if the remote DB exists."),c()):t(e):t(null,n)}),n.type=function(){return"http"},n.id=utils.adapterFun("id",function(e){s({headers:clone(i.headers),method:"GET",url:genUrl(i,"")},function(t,n){if(t)return e(t);var r=n.uuid+i.db;e(null,r)})}),n.request=utils.adapterFun("request",function(e,t){e.headers=i.headers,e.url=genDBUrl(i,e.url),s(e,t)}),n.compact=utils.adapterFun("compact",function(e,t){"function"==typeof e&&(t=e,e={}),e=clone(e),s({headers:clone(i.headers),url:genDBUrl(i,"_compact"),method:"POST"},function(){function r(){n.info(function(n,i){i.compact_running?setTimeout(r,e.interval||200):t(null,{ok:!0})})}r()})}),n._info=function(e){s({headers:clone(i.headers),method:"GET",url:genDBUrl(i,"")},function(t,n){return t?e(t):(n.host=genDBUrl(i,""),void e(null,n))})},n.get=utils.adapterFun("get",function(e,t,n){function s(e){var n=e._attachments,r=n&&Object.keys(n);return n&&r.length?Promise.all(r.map(function(r){var a=n[r],o=encodeDocId(e._id)+"/"+l(r)+"?rev="+e._rev;return u({headers:clone(i.headers),method:"GET",url:genDBUrl(i,o),binary:!0}).then(function(e){return t.binary?e:blufferToBase64(e)}).then(function(e){delete a.stub,delete a.length,a.data=e})})):void 0}function c(e){return Array.isArray(e)?Promise.all(e.map(function(e){return e.ok?s(e.ok):void 0})):s(e)}"function"==typeof t&&(n=t,t={}),t=clone(t);var r=[];t.revs&&r.push("revs=true"),t.revs_info&&r.push("revs_info=true"),t.open_revs&&("all"!==t.open_revs&&(t.open_revs=JSON.stringify(t.open_revs)),r.push("open_revs="+t.open_revs)),t.rev&&r.push("rev="+t.rev),t.conflicts&&r.push("conflicts="+t.conflicts),r=r.join("&"),r=""===r?"":"?"+r,e=encodeDocId(e);var a={headers:clone(i.headers),method:"GET",url:genDBUrl(i,e+r)},o=t.ajax||{};utils.extend(!0,a,o),u(a).then(function(e){return Promise.resolve().then(function(){return t.attachments?c(e):void 0}).then(function(){n(null,e)})})["catch"](n)}),n.remove=utils.adapterFun("remove",function(e,t,n,r){var a;"string"==typeof t?(a={_id:e,_rev:t},"function"==typeof n&&(r=n,n={})):(a=e,"function"==typeof t?(r=t,n={}):(r=n,n=t));var o=a._rev||n.rev;s({headers:clone(i.headers),method:"DELETE",url:genDBUrl(i,encodeDocId(a._id))+"?rev="+o},r)}),n.getAttachment=utils.adapterFun("getAttachment",function(e,t,n,r){"function"==typeof n&&(r=n,n={});var a=n.rev?"?rev="+n.rev:"",o=genDBUrl(i,encodeDocId(e))+"/"+l(t)+a;s({headers:clone(i.headers),method:"GET",url:o,binary:!0},r)}),n.removeAttachment=utils.adapterFun("removeAttachment",function(e,t,n,r){var a=genDBUrl(i,encodeDocId(e)+"/"+l(t))+"?rev="+n;s({headers:clone(i.headers),method:"DELETE",url:a},r)}),n.putAttachment=utils.adapterFun("putAttachment",function(e,t,n,r,a,u){"function"==typeof a&&(u=a,a=r,r=n,n=null);var c=encodeDocId(e)+"/"+l(t),f=genDBUrl(i,c);if(n&&(f+="?rev="+n),"string"==typeof r){var d;try{d=atob(r)}catch(p){return u(errors.error(errors.BAD_ARG,"Attachments need to be base64 encoded"))}r=d?binStringToBluffer(d,a):""}var h={headers:clone(i.headers),method:"PUT",url:f,processData:!1,body:r,timeout:o.timeout||6e4};h.headers["Content-Type"]=a,s(h,u)}),n.put=utils.adapterFun("put",utils.getArguments(function(e){var t,n,r,a=e.shift(),o="_id"in a,s=e.pop();return"object"!=typeof a||Array.isArray(a)?s(errors.error(errors.NOT_AN_OBJECT)):(a=clone(a),void preprocessAttachments(a).then(function(){for(;;)if(t=e.shift(),n=typeof t,"string"!==n||o?"string"!==n||!o||"_rev"in a?"object"===n&&(r=clone(t)):a._rev=t:(a._id=t,o=!0),!e.length)break;r=r||{},parseDoc.invalidIdError(a._id);var c=[];r&&"undefined"!=typeof r.new_edits&&c.push("new_edits="+r.new_edits),c=c.join("&"),""!==c&&(c="?"+c);var l={headers:clone(i.headers),method:"PUT",url:genDBUrl(i,encodeDocId(a._id))+c,body:a};return Promise.resolve().then(function(){var e=a._attachments&&Object.keys(a._attachments).filter(function(e){return!a._attachments[e].stub}).length;if(e){var t=createMultipart(a);l.body=t.body,l.processData=!1,l.headers=utils.extend(l.headers,t.headers)}})["catch"](function(){throw new Error("Did you forget to base64-encode an attachment?")}).then(function(){return u(l)}).then(function(e){e.ok=!0,s(null,e)})})["catch"](s))})),n.post=utils.adapterFun("post",function(e,t,r){return"function"==typeof t&&(r=t,t={}),t=clone(t),"object"!=typeof e?r(errors.error(errors.NOT_AN_OBJECT)):("_id"in e||(e._id=utils.uuid()),void n.put(e,t,function(e,t){return e?r(e):(t.ok=!0,void r(null,t))}))}),n._bulkDocs=function(e,t,n){e.new_edits=t.new_edits,Promise.all(e.docs.map(preprocessAttachments)).then(function(){s({headers:clone(i.headers),method:"POST",url:genDBUrl(i,"_bulk_docs"),body:e},function(e,t){return e?n(e):(t.forEach(function(e){e.ok=!0}),void n(null,t))})})["catch"](n)},n.allDocs=utils.adapterFun("allDocs",function(e,t){"function"==typeof e&&(t=e,e={}),e=clone(e);var r,n=[],a="GET";if(e.conflicts&&n.push("conflicts=true"),e.descending&&n.push("descending=true"),e.include_docs&&n.push("include_docs=true"),e.attachments&&n.push("attachments=true"),e.key&&n.push("key="+encodeURIComponent(JSON.stringify(e.key))),e.startkey&&n.push("startkey="+encodeURIComponent(JSON.stringify(e.startkey))),e.endkey&&n.push("endkey="+encodeURIComponent(JSON.stringify(e.endkey))),"undefined"!=typeof e.inclusive_end&&n.push("inclusive_end="+!!e.inclusive_end),"undefined"!=typeof e.limit&&n.push("limit="+e.limit),"undefined"!=typeof e.skip&&n.push("skip="+e.skip),n=n.join("&"),""!==n&&(n="?"+n),"undefined"!=typeof e.keys){var o="keys="+encodeURIComponent(JSON.stringify(e.keys));o.length+n.length+1<=MAX_URL_LENGTH?n+=(-1!==n.indexOf("?")?"&":"?")+o:(a="POST",r=JSON.stringify({keys:e.keys}))}u({headers:clone(i.headers),method:a,url:genDBUrl(i,"_all_docs"+n),body:r}).then(function(n){e.include_docs&&e.attachments&&e.binary&&n.rows.forEach(readAttachmentsAsBlobOrBuffer),t(null,n)})["catch"](t)}),n._changes=function(e){var t="batch_size"in e?e.batch_size:CHANGES_BATCH_SIZE;e=clone(e),e.timeout=e.timeout||o.timeout||3e4;var u,r={timeout:e.timeout-5e3},a="undefined"!=typeof e.limit?e.limit:!1;u="returnDocs"in e?e.returnDocs:!0;var c=a;if(e.style&&(r.style=e.style),(e.include_docs||e.filter&&"function"==typeof e.filter)&&(r.include_docs=!0),e.attachments&&(r.attachments=!0),e.continuous&&(r.feed="longpoll"),e.conflicts&&(r.conflicts=!0),e.descending&&(r.descending=!0),e.filter&&"string"==typeof e.filter&&(r.filter=e.filter,"_view"===e.filter&&e.view&&"string"==typeof e.view&&(r.view=e.view)),e.query_params&&"object"==typeof e.query_params)for(var l in e.query_params)e.query_params.hasOwnProperty(l)&&(r[l]=e.query_params[l]);var d,f="GET";if(e.doc_ids){r.filter="_doc_ids";var p=JSON.stringify(e.doc_ids);p.length<MAX_URL_LENGTH?r.doc_ids=p:(f="POST",d={doc_ids:e.doc_ids})}if(e.continuous&&n._useSSE)return n.sse(e,r,u);var h,m,v=function(n,o){if(!e.aborted){r.since=n,"object"==typeof r.since&&(r.since=JSON.stringify(r.since)),e.descending?a&&(r.limit=c):r.limit=!a||c>t?t:c;var u="?"+Object.keys(r).map(function(e){return e+"="+encodeURIComponent(r[e])}).join("&"),l={headers:clone(i.headers),method:f,url:genDBUrl(i,"_changes"+u),timeout:e.timeout,body:d};m=n,e.aborted||(h=s(l,o))}},g=10,b=0,y={results:[]},A=function(n,r){if(!e.aborted){var i=0;if(r&&r.results){i=r.results.length,y.last_seq=r.last_seq;var o={};o.query=e.query_params,r.results=r.results.filter(function(t){c--;var n=utils.filterChange(e)(t);return n&&(e.include_docs&&e.attachments&&e.binary&&readAttachmentsAsBlobOrBuffer(t),u&&y.results.push(t),e.onChange(t)),n})}else if(n)return e.aborted=!0,void utils.call(e.complete,n);r&&r.last_seq&&(m=r.last_seq);var s=a&&0>=c||r&&t>i||e.descending;if((!e.continuous||a&&0>=c)&&s)utils.call(e.complete,null,y);else{n?b+=1:b=0;var l=1<<b,f=g*l,d=e.maximumWait||3e4;if(f>d)return void utils.call(e.complete,n||errors.error(errors.UNKNOWN_ERROR));setTimeout(function(){v(m,A)},f)}}};return v(e.since||0,A),{cancel:function(){e.aborted=!0,h&&h.abort()}}},n.sse=function(e,t,r){function f(t){var n=JSON.parse(t.data);r&&u.results.push(n),u.last_seq=n.seq,utils.call(e.onChange,n)}function d(t){return s.removeEventListener("message",f,!1),l===!1?(n._useSSE=!1,void(c=n._changes(e))):(s.close(),void utils.call(e.complete,t))}t.feed="eventsource",t.since=e.since||0,t.limit=e.limit,delete t.timeout;var a="?"+Object.keys(t).map(function(e){return e+"="+t[e]}).join("&"),o=genDBUrl(i,"_changes"+a),s=new EventSource(o),u={results:[],last_seq:!1},c=!1,l=!1;return s.addEventListener("message",f,!1),s.onopen=function(){l=!0},s.onerror=d,{cancel:function(){return c?c.cancel():(s.removeEventListener("message",f,!1),void s.close())}}},n._useSSE=!1,n.revsDiff=utils.adapterFun("revsDiff",function(e,t,n){"function"==typeof t&&(n=t,t={}),s({headers:clone(i.headers),method:"POST",url:genDBUrl(i,"_revs_diff"),body:JSON.stringify(e)},n)}),n._close=function(e){e()},n._destroy=function(t){s({url:genDBUrl(i,""),method:"DELETE",headers:clone(i.headers)},function(r,i){return r?(n.emit("error",r),t(r)):(n.emit("destroyed"),n.constructor.emit("destroyed",e.name),void t(null,i))})}}var CHANGES_BATCH_SIZE=25,MAX_URL_LENGTH=1800,binStringToBluffer=require("../../deps/binary/binaryStringToBlobOrBuffer"),b64StringToBluffer=require("../../deps/binary/base64StringToBlobOrBuffer"),utils=require("../../utils"),Promise=utils.Promise,clone=utils.clone,base64=require("../../deps/binary/base64"),btoa=base64.btoa,atob=base64.atob,errors=require("../../deps/errors"),log=require("debug")("pouchdb:http"),createMultipart=require("../../deps/ajax/multipart"),blufferToBase64=require("../../deps/binary/blobOrBufferToBase64"),parseDoc=require("../../deps/docs/parseDoc");HttpPouch.valid=function(){return!0},module.exports=HttpPouch;
