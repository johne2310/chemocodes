"use strict";function idbBulkDocs(e,t,n,r,i,a){function E(){var e=[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,META_STORE,LOCAL_STORE,ATTACH_AND_SEQ_STORE],t=openTransactionSafely(r,e,"readwrite");return t.error?a(t.error):(s=t.txn,s.onerror=idbError(a),s.ontimeout=idbError(a),s.oncomplete=S,u=s.objectStore(DOC_STORE),c=s.objectStore(BY_SEQ_STORE),l=s.objectStore(ATTACH_STORE),f=s.objectStore(ATTACH_AND_SEQ_STORE),void I(function(e){return e?(y=!0,a(e)):void x()}))}function w(){processDocs(o,n,b,s,g,C,t)}function x(){function t(){++e===o.length&&w()}function n(e){var n=decodeMetadata(e.target.result);n&&b.set(n.id,n),t()}if(o.length)for(var e=0,r=0,i=o.length;i>r;r++){var a=o[r];if(a._id&&isLocalId(a._id))t();else{var s=u.get(a.metadata.id);s.onsuccess=n}}}function S(){y||(i.notify(n._meta.name),n._meta.docCount+=p,a(null,g))}function k(e,t){var n=l.get(e);n.onsuccess=function(n){if(n.target.result)t();else{var r=errors.error(errors.MISSING_STUB,"unknown stub attachment with digest "+e);r.status=412,t(r)}}}function I(e){function i(){++n===t.length&&e(r)}var t=[];if(o.forEach(function(e){e.data&&e.data._attachments&&Object.keys(e.data._attachments).forEach(function(n){var r=e.data._attachments[n];r.stub&&t.push(r.digest)})}),!t.length)return e();var r,n=0;t.forEach(function(e){k(e,function(e){e&&!r&&(r=e),i()})})}function C(e,t,n,r,i,a,o,s){p+=a;var u=e.data;u._id=e.metadata.id,u._rev=e.metadata.rev,r&&(u._deleted=!0);var c=u._attachments&&Object.keys(u._attachments).length;return c?T(e,t,n,i,o,s):void _(e,t,n,i,o,s)}function B(e){var t=utils.compactTree(e.metadata);compactRevs(t,e.metadata.id,s)}function _(e,t,r,i,a,o){function f(a){i&&n.auto_compaction&&B(e),l.seq=a.target.result,delete l.rev;var o=encodeMetadata(l,t,r),s=u.put(o);s.onsuccess=p}function d(e){e.preventDefault(),e.stopPropagation();var t=c.index("_doc_id_rev"),n=t.getKey(s._doc_id_rev);n.onsuccess=function(e){var t=c.put(s,e.target.result);t.onsuccess=f}}function p(){g[a]={ok:!0,id:l.id,rev:t},b.set(e.metadata.id,e.metadata),q(e,l.seq,o)}var s=e.data,l=e.metadata;s._doc_id_rev=l.id+"::"+l.rev,delete s._id,delete s._rev;var h=c.put(s);h.onsuccess=f,h.onerror=d}function T(e,t,n,r,i,a){function c(){s===u.length&&_(e,t,n,r,i,a)}function l(){s++,c()}var o=e.data,s=0,u=Object.keys(o._attachments);u.forEach(function(t){var n=e.data._attachments[t];if(n.stub)s++,c();else{var r=n.data;delete n.data;var i=n.digest;P(i,r,l)}})}function q(e,t,n){function a(){++r===i.length&&n()}function o(n){var r=e.data._attachments[n].digest,i=f.put({seq:t,digestSeq:r+"::"+t});i.onsuccess=a,i.onerror=function(e){e.preventDefault(),e.stopPropagation(),a()}}var r=0,i=Object.keys(e.data._attachments||{});if(!i.length)return n();for(var s=0;s<i.length;s++)o(i[s])}function P(e,t,n){var r=l.count(e);r.onsuccess=function(r){var i=r.target.result;if(i)return n();var a={digest:e,body:t},o=l.put(a);o.onsuccess=n}}for(var s,u,c,l,f,d,o=e.docs,p=0,h=0,m=o.length;m>h;h++){var v=o[h];v._id&&isLocalId(v._id)||(v=o[h]=utils.parseDoc(v,t.new_edits),v.error&&!d&&(d=v))}if(d)return a(d);var g=new Array(o.length),b=new utils.Map,y=!1,A=n._meta.blobSupport?"blob":"base64";preprocessAttachments(o,A,function(e){return e?a(e):void E()})}var utils=require("../../utils"),errors=require("../../deps/errors"),preprocessAttachments=require("../../deps/docs/preprocessAttachments"),processDocs=require("../../deps/docs/processDocs"),isLocalId=require("../../deps/docs/isLocalId"),idbUtils=require("./utils"),idbConstants=require("./constants"),ATTACH_AND_SEQ_STORE=idbConstants.ATTACH_AND_SEQ_STORE,ATTACH_STORE=idbConstants.ATTACH_STORE,BY_SEQ_STORE=idbConstants.BY_SEQ_STORE,DOC_STORE=idbConstants.DOC_STORE,LOCAL_STORE=idbConstants.LOCAL_STORE,META_STORE=idbConstants.META_STORE,compactRevs=idbUtils.compactRevs,decodeMetadata=idbUtils.decodeMetadata,encodeMetadata=idbUtils.encodeMetadata,idbError=idbUtils.idbError,openTransactionSafely=idbUtils.openTransactionSafely;module.exports=idbBulkDocs;
