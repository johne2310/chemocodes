"use strict";function tryCode(e,t,n){try{e.apply(t,n)}catch(r){"undefined"!=typeof PouchDB&&PouchDB.emit("error",r)}}var errors=require("../../deps/errors"),utils=require("../../utils"),base64=require("../../deps/binary/base64"),btoa=base64.btoa,constants=require("./constants"),readAsBinaryString=require("../../deps/binary/readAsBinaryString"),b64StringToBlob=require("../../deps/binary/base64StringToBlobOrBuffer"),createBlob=require("../../deps/binary/blob");exports.taskQueue={running:!1,queue:[]},exports.applyNext=function(){if(!exports.taskQueue.running&&exports.taskQueue.queue.length){exports.taskQueue.running=!0;var e=exports.taskQueue.queue.shift();e.action(function(t,n){tryCode(e.callback,this,[t,n]),exports.taskQueue.running=!1,process.nextTick(exports.applyNext)})}},exports.idbError=function(e){return function(t){var n=t.target&&t.target.error&&t.target.error.name||t.target;e(errors.error(errors.IDB_ERROR,n,t.type))}},exports.encodeMetadata=function(e,t,n){return{data:utils.safeJsonStringify(e),winningRev:t,deletedOrLocal:n?"1":"0",seq:e.seq,id:e.id}},exports.decodeMetadata=function(e){if(!e)return null;var t=utils.safeJsonParse(e.data);return t.winningRev=e.winningRev,t.deleted="1"===e.deletedOrLocal,t.seq=e.seq,t},exports.decodeDoc=function(e){if(!e)return e;var t=e._doc_id_rev.lastIndexOf(":");return e._id=e._doc_id_rev.substring(0,t-1),e._rev=e._doc_id_rev.substring(t+1),delete e._doc_id_rev,e},exports.readBlobData=function(e,t,n,r){n?r(e?"string"!=typeof e?e:b64StringToBlob(e,t):createBlob([""],{type:t})):e?"string"!=typeof e?readAsBinaryString(e,function(e){r(btoa(e))}):r(e):r("")},exports.fetchAttachmentsIfNecessary=function(e,t,n,r){function o(){++a===i.length&&r&&r()}function s(e,t){var r=e._attachments[t],i=r.digest,a=n.objectStore(constants.ATTACH_STORE).get(i);a.onsuccess=function(e){r.body=e.target.result.body,o()}}var i=Object.keys(e._attachments||{});if(!i.length)return r&&r();var a=0;i.forEach(function(n){t.attachments&&t.include_docs?s(e,n):(e._attachments[n].stub=!0,o())})},exports.postProcessAttachments=function(e,t){return utils.Promise.all(e.map(function(e){if(e.doc&&e.doc._attachments){var n=Object.keys(e.doc._attachments);return utils.Promise.all(n.map(function(n){var r=e.doc._attachments[n];if("body"in r){var i=r.body,a=r.content_type;return new utils.Promise(function(o){exports.readBlobData(i,a,t,function(t){e.doc._attachments[n]=utils.extend(utils.pick(r,["digest","content_type"]),{data:t}),o()})})}}))}}))},exports.compactRevs=function(e,t,n){function u(){s--,s||c()}function c(){r.length&&r.forEach(function(e){var t=o.index("digestSeq").count(IDBKeyRange.bound(e+"::",e+"::ï¿¿",!1,!1));t.onsuccess=function(t){var n=t.target.result;n||a["delete"](e)}})}var r=[],i=n.objectStore(constants.BY_SEQ_STORE),a=n.objectStore(constants.ATTACH_STORE),o=n.objectStore(constants.ATTACH_AND_SEQ_STORE),s=e.length;e.forEach(function(e){var n=i.index("_doc_id_rev"),a=t+"::"+e;n.getKey(a).onsuccess=function(e){var t=e.target.result;if("number"!=typeof t)return u();i["delete"](t);var n=o.index("seq").openCursor(IDBKeyRange.only(t));n.onsuccess=function(e){var t=e.target.result;if(t){var n=t.value.digestSeq.split("::")[0];r.push(n),o["delete"](t.primaryKey),t["continue"]()}else u()}}})},exports.openTransactionSafely=function(e,t,n){try{return{txn:e.transaction(t,n)}}catch(r){return{error:r}}};
