"use strict";function IdbPouch(e,t){var n=this;taskQueue.queue.push({action:function(t){init(n,e,t)},callback:t}),applyNext()}function init(e,t,n){function a(e){var t=e.createObjectStore(DOC_STORE,{keyPath:"id"});e.createObjectStore(BY_SEQ_STORE,{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),e.createObjectStore(ATTACH_STORE,{keyPath:"digest"}),e.createObjectStore(META_STORE,{keyPath:"id",autoIncrement:!1}),e.createObjectStore(DETECT_BLOB_SUPPORT_STORE),t.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1}),e.createObjectStore(LOCAL_STORE,{keyPath:"_id"});var n=e.createObjectStore(ATTACH_AND_SEQ_STORE,{autoIncrement:!0});n.createIndex("seq","seq"),n.createIndex("digestSeq","digestSeq",{unique:!0})}function o(e,t){var n=e.objectStore(DOC_STORE);n.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1}),n.openCursor().onsuccess=function(e){var r=e.target.result;if(r){var i=r.value,a=isDeleted(i);i.deletedOrLocal=a?"1":"0",n.put(i),r["continue"]()}else t()}}function s(e){e.createObjectStore(LOCAL_STORE,{keyPath:"_id"}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0})}function u(e,t){var n=e.objectStore(LOCAL_STORE),r=e.objectStore(DOC_STORE),i=e.objectStore(BY_SEQ_STORE),a=r.openCursor();a.onsuccess=function(e){var a=e.target.result;if(a){var o=a.value,s=o.id,u=isLocalId(s),c=merge.winningRev(o);if(u){var l=s+"::"+c,f=s+"::",d=s+"::~",p=i.index("_doc_id_rev"),h=IDBKeyRange.bound(f,d,!1,!1),m=p.openCursor(h);m.onsuccess=function(e){if(m=e.target.result){var t=m.value;t._doc_id_rev===l&&n.put(t),i["delete"](m.primaryKey),m["continue"]()}else r["delete"](a.primaryKey),a["continue"]()}}else a["continue"]()}else t&&t()}}function c(e){var t=e.createObjectStore(ATTACH_AND_SEQ_STORE,{autoIncrement:!0});t.createIndex("seq","seq"),t.createIndex("digestSeq","digestSeq",{unique:!0})}function l(e,t){var n=e.objectStore(BY_SEQ_STORE),r=e.objectStore(ATTACH_STORE),i=e.objectStore(ATTACH_AND_SEQ_STORE),a=r.count();a.onsuccess=function(e){var r=e.target.result;return r?void(n.openCursor().onsuccess=function(e){var n=e.target.result;if(!n)return t();for(var r=n.value,a=n.primaryKey,o=Object.keys(r._attachments||{}),s={},u=0;u<o.length;u++){var c=r._attachments[o[u]];s[c.digest]=!0}var l=Object.keys(s);for(u=0;u<l.length;u++){var f=l[u];i.put({seq:a,digestSeq:f+"::"+a})}n["continue"]()}):t()}}function f(e){function t(e){return e.data?decodeMetadata(e):(e.deleted="1"===e.deletedOrLocal,e)}var n=e.objectStore(BY_SEQ_STORE),r=e.objectStore(DOC_STORE),i=r.openCursor();i.onsuccess=function(e){function o(){var e=a.id+"::",t=a.id+"::￿",r=n.index("_doc_id_rev").openCursor(IDBKeyRange.bound(e,t)),i=0;r.onsuccess=function(e){var t=e.target.result;if(!t)return a.seq=i,s();var n=t.primaryKey;n>i&&(i=n),t["continue"]()}}function s(){var e=encodeMetadata(a,a.winningRev,a.deleted),t=r.put(e);t.onsuccess=function(){i["continue"]()}}var i=e.target.result;if(i){var a=t(i.value);return a.winningRev=a.winningRev||merge.winningRev(a),a.seq?s():void o()}}}var r=t.name,i=null;e._meta=null,e.type=function(){return"idb"},e._id=utils.toPromise(function(t){t(null,e._meta.instanceId)}),e._bulkDocs=function(t,n,r){idbBulkDocs(t,n,e,i,IdbPouch.Changes,r)},e._get=function(e,t,n){function c(){n(o,{doc:r,metadata:a,ctx:s})}var r,a,o,s;if(t=utils.clone(t),t.ctx)s=t.ctx;else{var u=openTransactionSafely(i,[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");if(u.error)return n(u.error);s=u.txn}s.objectStore(DOC_STORE).get(e).onsuccess=function(e){if(a=decodeMetadata(e.target.result),!a)return o=errors.error(errors.MISSING_DOC,"missing"),c();if(isDeleted(a)&&!t.rev)return o=errors.error(errors.MISSING_DOC,"deleted"),c();var n=s.objectStore(BY_SEQ_STORE),i=t.rev||a.winningRev,u=a.id+"::"+i;n.index("_doc_id_rev").get(u).onsuccess=function(e){return r=e.target.result,r&&(r=decodeDoc(r)),r?void c():(o=errors.error(errors.MISSING_DOC,"missing"),c())}}},e._getAttachment=function(e,t,n){var r;if(t=utils.clone(t),t.ctx)r=t.ctx;else{var a=openTransactionSafely(i,[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");if(a.error)return n(a.error);r=a.txn}var o=e.digest,s=e.content_type;r.objectStore(ATTACH_STORE).get(o).onsuccess=function(e){var r=e.target.result.body;readBlobData(r,s,t.binary,function(e){n(null,e)})}},e._info=function(t){if(null===i||!cachedDBs[r]){var n=new Error("db isn't open");return n.id="idbNull",t(n)}var a,o,s=openTransactionSafely(i,[BY_SEQ_STORE],"readonly");if(s.error)return t(s.error);var u=s.txn,c=u.objectStore(BY_SEQ_STORE).openCursor(null,"prev");c.onsuccess=function(t){var n=t.target.result;a=n?n.key:0,o=e._meta.docCount},u.oncomplete=function(){t(null,{doc_count:o,update_seq:a,idb_attachment_format:e._meta.blobSupport?"binary":"base64"})}},e._allDocs=function(t,n){idbAllDocs(t,e,i,n)},e._changes=function(t){function g(e){function o(){return i.seq!==r?e["continue"]():(s=r,i.winningRev===n._rev?b(n):void g())}function g(){var e=n._id+"::"+i.winningRev,t=m.index("_doc_id_rev").openCursor(IDBKeyRange.bound(e,e+"￿"));t.onsuccess=function(e){b(decodeDoc(e.target.result.value))}}function b(n){var r=t.processChange(n,i,t);r.seq=i.seq,d(r)&&(f++,c&&l.push(r),t.attachments&&t.include_docs?fetchAttachmentsIfNecessary(n,t,h,function(){postProcessAttachments([r],t.binary).then(function(){t.onChange(r)})}):t.onChange(r)),f!==u&&e["continue"]()}var n=decodeDoc(e.value),r=e.key;if(a&&!a.has(n._id))return e["continue"]();var i;return(i=p.get(n._id))?o():void(v.get(n._id).onsuccess=function(e){i=decodeMetadata(e.target.result),p.set(n._id,i),o()})}function b(e){var t=e.target.result;t&&g(t)}function y(){var e=[DOC_STORE,BY_SEQ_STORE];t.attachments&&e.push(ATTACH_STORE);var n=openTransactionSafely(i,e,"readonly");if(n.error)return t.complete(n.error);h=n.txn,h.onerror=idbError(t.complete),h.oncomplete=A,m=h.objectStore(BY_SEQ_STORE),v=h.objectStore(DOC_STORE);var r;r=o?m.openCursor(null,o):m.openCursor(IDBKeyRange.lowerBound(t.since,!0)),r.onsuccess=b}function A(){function e(){t.complete(null,{results:l,last_seq:s})}!t.continuous&&t.attachments?postProcessAttachments(l).then(e):e()}if(t=utils.clone(t),t.continuous){var n=r+":"+utils.uuid();return IdbPouch.Changes.addListener(r,n,e,t),IdbPouch.Changes.notify(r),{cancel:function(){IdbPouch.Changes.removeListener(r,n)}}}var a=t.doc_ids&&new utils.Set(t.doc_ids),o=t.descending?"prev":null;t.since=t.since||0;var s=t.since,u="limit"in t?t.limit:-1;0===u&&(u=1);var c;c="returnDocs"in t?t.returnDocs:!0;var h,m,v,l=[],f=0,d=utils.filterChange(t),p=new utils.Map;y()},e._close=function(e){return null===i?e(errors.error(errors.NOT_OPEN)):(i.close(),delete cachedDBs[r],i=null,void e())},e._getRevisionTree=function(e,t){var n=openTransactionSafely(i,[DOC_STORE],"readonly");if(n.error)return t(n.error);var r=n.txn,a=r.objectStore(DOC_STORE).get(e);a.onsuccess=function(e){var n=decodeMetadata(e.target.result);n?t(null,n.rev_tree):t(errors.error(errors.MISSING_DOC))}},e._doCompaction=function(e,t,n){var r=[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,ATTACH_AND_SEQ_STORE],a=openTransactionSafely(i,r,"readwrite");if(a.error)return n(a.error);var o=a.txn,s=o.objectStore(DOC_STORE);s.get(e).onsuccess=function(n){var r=decodeMetadata(n.target.result);merge.traverseRevTree(r.rev_tree,function(e,n,r,i,a){var o=n+"-"+r;-1!==t.indexOf(o)&&(a.status="missing")}),compactRevs(t,e,o);var i=r.winningRev,a=r.deleted;o.objectStore(DOC_STORE).put(encodeMetadata(r,i,a))},o.onerror=idbError(n),o.oncomplete=function(){utils.call(n)}},e._getLocal=function(e,t){var n=openTransactionSafely(i,[LOCAL_STORE],"readonly");if(n.error)return t(n.error);var r=n.txn,a=r.objectStore(LOCAL_STORE).get(e);a.onerror=idbError(t),a.onsuccess=function(e){var n=e.target.result;n?(delete n._doc_id_rev,t(null,n)):t(errors.error(errors.MISSING_DOC))}},e._putLocal=function(e,t,n){"function"==typeof t&&(n=t,t={}),delete e._revisions;var r=e._rev,a=e._id;r?e._rev="0-"+(parseInt(r.split("-")[1],10)+1):e._rev="0-1";var s,o=t.ctx;if(!o){var u=openTransactionSafely(i,[LOCAL_STORE],"readwrite");if(u.error)return n(u.error);o=u.txn,o.onerror=idbError(n),o.oncomplete=function(){s&&n(null,s)}}var l,c=o.objectStore(LOCAL_STORE);r?(l=c.get(a),l.onsuccess=function(i){var a=i.target.result;if(a&&a._rev===r){var o=c.put(e);o.onsuccess=function(){s={ok:!0,id:e._id,rev:e._rev},t.ctx&&n(null,s)}}else n(errors.error(errors.REV_CONFLICT))}):(l=c.add(e),l.onerror=function(e){n(errors.error(errors.REV_CONFLICT)),e.preventDefault(),e.stopPropagation()},l.onsuccess=function(){s={ok:!0,id:e._id,rev:e._rev},t.ctx&&n(null,s)})},e._removeLocal=function(e,t,n){"function"==typeof t&&(n=t,t={});var r=t.ctx;if(!r){var a=openTransactionSafely(i,[LOCAL_STORE],"readwrite");if(a.error)return n(a.error);r=a.txn,r.oncomplete=function(){o&&n(null,o)}}var o,s=e._id,u=r.objectStore(LOCAL_STORE),c=u.get(s);c.onerror=idbError(n),c.onsuccess=function(r){var i=r.target.result;i&&i._rev===e._rev?(u["delete"](s),o={ok:!0,id:s,rev:"0-0"},t.ctx&&n(null,o)):n(errors.error(errors.MISSING_DOC))}},e._destroy=function(e){IdbPouch.Changes.removeAllListeners(r),IdbPouch.openReqList[r]&&IdbPouch.openReqList[r].result&&(IdbPouch.openReqList[r].result.close(),delete cachedDBs[r]);var t=indexedDB.deleteDatabase(r);t.onsuccess=function(){IdbPouch.openReqList[r]&&(IdbPouch.openReqList[r]=null),hasLocalStorage()&&r in localStorage&&delete localStorage[r],e(null,{ok:!0})},t.onerror=idbError(e)};var d=cachedDBs[r];if(d)return i=d.idb,e._meta=d.global,void process.nextTick(function(){n(null,e)});var p=indexedDB.open(r,ADAPTER_VERSION);"openReqList"in IdbPouch||(IdbPouch.openReqList={}),IdbPouch.openReqList[r]=p,p.onupgradeneeded=function(e){function d(){var e=r[i-1];i++,e&&e(n,d)}var t=e.target.result;if(e.oldVersion<1)return a(t);var n=e.currentTarget.transaction;e.oldVersion<3&&s(t),e.oldVersion<4&&c(t);var r=[o,u,l,f],i=e.oldVersion;d()},p.onsuccess=function(t){i=t.target.result,i.onversionchange=function(){i.close(),delete cachedDBs[r]},i.onabort=function(){i.close(),delete cachedDBs[r]};var a=i.transaction([META_STORE,DETECT_BLOB_SUPPORT_STORE,DOC_STORE],"readwrite"),o=a.objectStore(META_STORE).get(META_STORE),s=null,u=null,c=null;o.onsuccess=function(t){var o=function(){null!==s&&null!==u&&null!==c&&(e._meta={name:r,instanceId:c,blobSupport:s,docCount:u},cachedDBs[r]={idb:i,global:e._meta},n(null,e))},l=t.target.result||{id:META_STORE};r+"_id"in l?(c=l[r+"_id"],o()):(c=utils.uuid(),l[r+"_id"]=c,a.objectStore(META_STORE).put(l).onsuccess=function(){o()}),blobSupportPromise||(blobSupportPromise=checkBlobSupport(a,i)),blobSupportPromise.then(function(e){s=e,o()});var f=a.objectStore(DOC_STORE).index("deletedOrLocal");f.count(IDBKeyRange.only("0")).onsuccess=function(e){u=e.target.result,o()}}},p.onerror=function(e){var t="Failed to open indexedDB, are you in private browsing mode?";console.error(t),n(errors.error(errors.IDB_ERROR,t))}}var utils=require("../../utils"),merge=require("../../merge"),isDeleted=require("../../deps/docs/isDeleted"),isLocalId=require("../../deps/docs/isLocalId"),errors=require("../../deps/errors"),idbUtils=require("./utils"),idbConstants=require("./constants"),idbBulkDocs=require("./bulkDocs"),idbAllDocs=require("./allDocs"),checkBlobSupport=require("./blobSupport"),hasLocalStorage=require("../../deps/env/hasLocalStorage"),ADAPTER_VERSION=idbConstants.ADAPTER_VERSION,ATTACH_AND_SEQ_STORE=idbConstants.ATTACH_AND_SEQ_STORE,ATTACH_STORE=idbConstants.ATTACH_STORE,BY_SEQ_STORE=idbConstants.BY_SEQ_STORE,DETECT_BLOB_SUPPORT_STORE=idbConstants.DETECT_BLOB_SUPPORT_STORE,DOC_STORE=idbConstants.DOC_STORE,LOCAL_STORE=idbConstants.LOCAL_STORE,META_STORE=idbConstants.META_STORE,applyNext=idbUtils.applyNext,compactRevs=idbUtils.compactRevs,decodeDoc=idbUtils.decodeDoc,decodeMetadata=idbUtils.decodeMetadata,encodeMetadata=idbUtils.encodeMetadata,fetchAttachmentsIfNecessary=idbUtils.fetchAttachmentsIfNecessary,idbError=idbUtils.idbError,postProcessAttachments=idbUtils.postProcessAttachments,readBlobData=idbUtils.readBlobData,taskQueue=idbUtils.taskQueue,openTransactionSafely=idbUtils.openTransactionSafely,cachedDBs={},blobSupportPromise;IdbPouch.valid=function(){var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform);return!e&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange},IdbPouch.Changes=new utils.Changes,module.exports=IdbPouch;
