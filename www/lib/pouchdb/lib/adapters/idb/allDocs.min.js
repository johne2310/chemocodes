"use strict";function createKeyRange(e,t,n,r,i){try{if(e&&t)return i?IDBKeyRange.bound(t,e,!n,!1):IDBKeyRange.bound(e,t,!1,!n);if(e)return i?IDBKeyRange.upperBound(e):IDBKeyRange.lowerBound(e);if(t)return i?IDBKeyRange.lowerBound(t,!n):IDBKeyRange.upperBound(t,!n);if(r)return IDBKeyRange.only(r)}catch(a){return{error:a}}return null}function handleKeyRangeError(e,t,n,r){return"DataError"===n.name&&0===n.code?r(null,{total_rows:e._meta.docCount,offset:t.skip,rows:[]}):void r(errors.error(errors.IDB_ERROR,n.name,n.message))}function idbAllDocs(e,t,n,r){function i(e,r){function E(t,n,r){var i=t.id+"::"+r;b.get(i).onsuccess=function(r){n.doc=decodeDoc(r.target.result),e.conflicts&&(n.doc._conflicts=merge.collectConflicts(t)),fetchAttachmentsIfNecessary(n.doc,e,h)}}function w(t,n,r){var i={id:r.id,key:r.id,value:{rev:n}},a=r.deleted;if("ok"===e.deleted)y.push(i),a?(i.value.deleted=!0,i.doc=null):e.include_docs&&E(r,i,n);else if(!a&&s--<=0&&(y.push(i),e.include_docs&&E(r,i,n),0===--u))return;t["continue"]()}function x(e){A=t._meta.docCount;var n=e.target.result;if(n){var r=decodeMetadata(n.value),i=r.winningRev;w(n,i,r)}}function S(){r(null,{total_rows:A,offset:e.skip,rows:y})}function k(){e.attachments?postProcessAttachments(y,e.binary).then(S):S()}var i="startkey"in e?e.startkey:!1,a="endkey"in e?e.endkey:!1,o="key"in e?e.key:!1,s=e.skip||0,u="number"==typeof e.limit?e.limit:-1,c=e.inclusive_end!==!1,l="descending"in e&&e.descending?"prev":null,f=createKeyRange(i,a,c,o,l);if(f&&f.error)return handleKeyRangeError(t,e,f.error,r);var d=[DOC_STORE,BY_SEQ_STORE];e.attachments&&d.push(ATTACH_STORE);var p=openTransactionSafely(n,d,"readonly");if(p.error)return r(p.error);var h=p.txn,m=h.objectStore(DOC_STORE),v=h.objectStore(BY_SEQ_STORE),g=l?m.openCursor(f,l):m.openCursor(f),b=v.index("_doc_id_rev"),y=[],A=0;h.oncomplete=k,g.onsuccess=x}function a(e,n){return 0===e.limit?n(null,{total_rows:t._meta.docCount,offset:e.skip,rows:[]}):void i(e,n)}a(e,r)}var merge=require("../../merge"),errors=require("../../deps/errors"),idbUtils=require("./utils"),idbConstants=require("./constants"),ATTACH_STORE=idbConstants.ATTACH_STORE,BY_SEQ_STORE=idbConstants.BY_SEQ_STORE,DOC_STORE=idbConstants.DOC_STORE,decodeDoc=idbUtils.decodeDoc,decodeMetadata=idbUtils.decodeMetadata,fetchAttachmentsIfNecessary=idbUtils.fetchAttachmentsIfNecessary,postProcessAttachments=idbUtils.postProcessAttachments,openTransactionSafely=idbUtils.openTransactionSafely;module.exports=idbAllDocs;
