"use strict";function requireLeveldown(){try{originalLeveldown=require("leveldown")}catch(e){}}function fetchAttachment(e,t,n){var r=e.content_type;return new utils.Promise(function(i,a){t.binaryStore.get(e.digest,function(t,o){var s;if(t){if("NotFoundError"!==t.name)return a(t);s=n.binary?binStringToBluffer("",r):""}else s=n.binary?readAsBluffer(o,r):btoa(o);delete e.stub,delete e.length,e.data=s,i()})})}function fetchAttachments(e,t,n){var r=[];return e.forEach(function(e){if(e.doc&&e.doc._attachments){var t=Object.keys(e.doc._attachments);t.forEach(function(t){var n=e.doc._attachments[t];"data"in n||r.push(n)})}}),utils.Promise.all(r.map(function(e){return fetchAttachment(e,t,n)}))}function LevelPouch(e,t){function c(){i.docStore=a.sublevel(DOC_STORE,{valueEncoding:safeJsonEncoding}),i.bySeqStore=a.sublevel(BY_SEQ_STORE,{valueEncoding:"json"}),i.attachmentStore=a.sublevel(ATTACHMENT_STORE,{valueEncoding:"json"}),i.binaryStore=a.sublevel(BINARY_STORE,{valueEncoding:"binary"}),i.localStore=a.sublevel(LOCAL_STORE,{valueEncoding:"json"}),i.metaStore=a.sublevel(META_STORE,{valueEncoding:"json"}),migrate.localAndMetaStores(a,i,function(){i.metaStore.get(UPDATE_SEQ_KEY,function(e,o){"undefined"==typeof a._updateSeq&&(a._updateSeq=o||0),i.metaStore.get(DOC_COUNT_KEY,function(e,o){a._docCount=e?0:o,i.metaStore.get(UUID_KEY,function(e,a){r=e?utils.uuid():a,i.metaStore.put(UUID_KEY,r,function(e,r){process.nextTick(function(){t(null,n)})})})})})})}function l(e){return a.isClosed()?e(new Error("database is closed")):e(null,a._docCount)}function f(e,t){try{e.apply(null,t)}catch(n){t[t.length-1](n)}}function d(){var e=a._queue.peekFront();"read"===e.type?p(e):h(e)}function p(e){for(var t=[e],n=1,r=a._queue.get(n);"undefined"!=typeof r&&"read"===r.type;)t.push(r),n++,r=a._queue.get(n);var i=0;t.forEach(function(e){var n=e.args,r=n[n.length-1];n[n.length-1]=utils.getArguments(function(e){r.apply(null,e),++i===t.length&&process.nextTick(function(){t.forEach(function(){a._queue.shift()}),a._queue.length&&d()})}),f(e.fun,n)})}function h(e){var t=e.args,n=t[t.length-1];t[t.length-1]=utils.getArguments(function(e){n.apply(null,e),process.nextTick(function(){a._queue.shift(),a._queue.length&&d()})}),f(e.fun,t)}function m(e){return utils.getArguments(function(t){a._queue.push({fun:e,args:t,type:"write"}),1===a._queue.length&&process.nextTick(d)})}function v(e){return utils.getArguments(function(t){a._queue.push({fun:e,args:t,type:"read"}),1===a._queue.length&&process.nextTick(d)})}function g(e){return("0000000000000000"+e).slice(-16)}function b(e){return parseInt(e,10)}function y(e,t){"function"==typeof s.destroy?s.destroy(e,t):process.nextTick(t)}e=utils.clone(e);var r,a,n=this,i={},o=e.name;"undefined"==typeof e.createIfMissing&&(e.createIfMissing=!0);var s=e.db||originalLeveldown;if(!s)return t(new Error("leveldown not available (specify another backend using the 'db' option)"));"function"!=typeof s.destroy&&(s.destroy=function(e,t){t()});var u;dbStores.has(s.name)?u=dbStores.get(s.name):(u=new utils.Map,dbStores.set(s.name,u)),u.has(o)?(a=u.get(o),c()):u.set(o,sublevel(levelup(o,e,function(n){return n?(u["delete"](o),t(n)):(a=u.get(o),a._docCount=-1,a._queue=new Deque,void(e.db||e.noMigrate?c():migrate.toSublevel(o,a,c)))}))),n.type=function(){return"leveldb"},n._id=function(e){e(null,r)},n._info=function(e){var t={doc_count:a._docCount,update_seq:a._updateSeq,backend_adapter:s.name};return process.nextTick(function(){e(null,t)})},n._get=v(function(e,t,n){t=utils.clone(t),i.docStore.get(e,function(e,r){if(e||!r)return n(errors.error(errors.MISSING_DOC,"missing"));if(isDeleted(r)&&!t.rev)return n(errors.error(errors.MISSING_DOC,"deleted"));var a=merge.winningRev(r);a=t.rev?t.rev:a;var o=r.rev_map[a];i.bySeqStore.get(g(o),function(e,t){if(!t)return n(errors.error(errors.MISSING_DOC));if("_id"in t&&t._id!==r.id)return n(new Error("wrong doc returned"));if(t._id=r.id,"_rev"in t){if(t._rev!==a)return n(new Error("wrong doc returned"))}else t._rev=a;return n(null,{doc:t,metadata:r})})})}),n._getAttachment=function(e,t,n){var r=e.digest,a=e.content_type;i.binaryStore.get(r,function(e,r){return e?"NotFoundError"!==e.name?n(e):n(null,t.binary?createEmptyBluffer(a):""):void(t.binary?n(null,readAsBluffer(r,a)):n(null,btoa(r)))})},n._bulkDocs=m(function(e,t,r){function v(e,t){l.get(i.attachmentStore,e,function(n){if(n){var r=errors.error(errors.MISSING_STUB,"unknown stub attachment with digest "+e);t(r)}else t()})}function b(e){var t=[];if(p.forEach(function(e){e&&e._attachments&&Object.keys(e._attachments).forEach(function(n){var r=e._attachments[n];r.stub&&t.push(r.digest)})}),!t.length)return e();var r,n=0;t.forEach(function(i){v(i,function(i){i&&!r&&(r=i),++n===t.length&&e(r)})})}function y(e){function r(){return++t===p.length?e(n):void 0}var n,t=0;p.forEach(function(e){return e._id&&isLocalId(e._id)?r():void l.get(i.docStore,e._id,function(t,i){t?"NotFoundError"!==t.name&&(n=t):c.set(e._id,i),r()})})}function A(e){var t=utils.Promise.resolve();c.forEach(function(e,r){t=t.then(function(){return new utils.Promise(function(t,i){var a=utils.compactTree(e);n._doCompactionNoLock(r,a,{ctx:l},function(e){return e?i(e):void t()})})})}),t.then(function(){e()},e)}function E(){return n.auto_compaction?A(I):I()}function w(e,t,n,a,o,s,p,h){function y(e){v++,m||(e?(m=e,h(m)):v===b.length&&q())}function A(e,t,n,r){return function(i){k(e,MD5_PREFIX+i,t,n,r)}}function E(e,t,n){return function(r){md5(r).then(A(e,t,r,n))}}function q(){var n=e.metadata.rev_map[e.metadata.rev];if(n)return h();n=++d,e.metadata.rev_map[e.metadata.rev]=e.metadata.seq=n;var r=g(n),a=[{key:r,value:e.data,prefix:i.bySeqStore,type:"put",valueEncoding:"json"},{key:e.metadata.id,value:e.metadata,prefix:i.docStore,type:"put",valueEncoding:safeJsonEncoding}];l.batch(a),u[p]={ok:!0,id:e.metadata.id,rev:t},c.set(e.metadata.id,e.metadata),h()}f+=s;var m=null,v=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,a&&(e.data._deleted=!0);for(var b=e.data._attachments?Object.keys(e.data._attachments):[],w=0;w<b.length;w++){var x=b[w],I=e.data._attachments[x];if(I.stub){var C=e.data._id,B=e.data._rev;S(C,B,I.digest,y)}else{var _;if("string"==typeof I.data){try{_=atob(I.data)}catch(T){return void r(errors.error(errors.BAD_ARG,"Attachments need to be base64 encoded"))}E(e,x,y)(_)}else prepareAttachmentForStorage(I.data,E(e,x,y))}}b.length||q()}function S(e,t,n,r){function a(){return new utils.Promise(function(e,t){l.get(i.attachmentStore,n,function(n,r){return n&&"NotFoundError"!==n.name?t(n):void e(r)})})}function o(r){var a=[e,t].join("@"),o={};return r?r.refs&&(o.refs=r.refs,o.refs[a]=!0):(o.refs={},o.refs[a]=!0),new utils.Promise(function(e,t){l.batch([{type:"put",prefix:i.attachmentStore,key:n,value:o,valueEncoding:"json"}]),e(!r)})}var s=x[n]||utils.Promise.resolve();x[n]=s.then(function(){return a().then(o).then(function(e){r(null,e)},r)})}function k(e,t,n,r,a){var o=e.data._attachments[n];delete o.data,o.digest=t,o.length=r.length;var s=e.metadata.id,u=e.metadata.rev;S(s,u,t,function(e,n){return e?a(e):0===r.length?a(e):n?(l.batch([{type:"put",prefix:i.binaryStore,key:t,value:new Buffer(r,"binary"),encoding:"binary"}]),void a()):a(e)})}function I(e){return e?process.nextTick(function(){r(e)}):(l.batch([{prefix:i.metaStore,type:"put",key:UPDATE_SEQ_KEY,value:d,encoding:"json"},{prefix:i.metaStore,type:"put",key:DOC_COUNT_KEY,value:a._docCount+f,encoding:"json"}]),void l.execute(a,function(e){return e?r(e):(a._docCount+=f,a._updateSeq=d,LevelPouch.Changes.notify(o),void process.nextTick(function(){r(null,u)}))}))}var s=t.new_edits,u=new Array(e.docs.length),c=new utils.Map,l=new LevelTransaction,f=0,d=a._updateSeq,p=e.docs,h=p.map(function(e,t){if(e._id&&isLocalId(e._id))return e;var n=utils.parseDoc(e,s);return n.metadata&&!n.metadata.rev_map&&(n.metadata.rev_map={}),n}),m=h.filter(function(e){return e.error});if(m.length)return r(m[0]);var x={};return h.length?void b(function(e){return e?r(e):void y(function(e){return e?r(e):void processDocs(h,n,c,l,u,w,t,E)})}):r(null,[])}),n._allDocs=v(function(e,t){e=utils.clone(e),l(function(n,r){if(n)return t(n);var a={},o=e.skip||0;if(e.startkey&&(a.start=e.startkey),e.endkey&&(a.end=e.endkey),e.key&&(a.start=a.end=e.key),e.descending){a.reverse=!0;var s=a.start;a.start=a.end,a.end=s}var u;if("number"==typeof e.limit&&(u=e.limit),0===u||"start"in a&&"end"in a&&a.start>a.end)return t(null,{total_rows:r,offset:e.skip,rows:[]});var c=[],l=i.docStore.readStream(a),f=through(function(t,n,r){function a(t,n){var i={id:t.id,key:t.id,value:{rev:merge.winningRev(t)}};if(e.include_docs){i.doc=n,i.doc._rev=i.value.rev,e.conflicts&&(i.doc._conflicts=merge.collectConflicts(t));for(var a in i.doc._attachments)i.doc._attachments.hasOwnProperty(a)&&(i.doc._attachments[a].stub=!0)}if(e.inclusive_end===!1&&t.id===e.endkey)return r();if(isDeleted(t)){if("ok"!==e.deleted)return r();i.value.deleted=!0,i.doc=null}c.push(i),r()}if(isDeleted(t.value)){if("ok"!==e.deleted)return void r()}else{if(o-->0)return void r();if("number"==typeof u&&u--<=0)return l.unpipe(),l.destroy(),void r()}var s=t.value;if(e.include_docs){var f=s.rev_map[merge.winningRev(s)];i.bySeqStore.get(g(f),function(e,t){a(s,t)})}else a(s)},function(n){utils.Promise.resolve().then(function(){return e.include_docs&&e.attachments?fetchAttachments(c,i,e):void 0}).then(function(){t(null,{total_rows:r,offset:e.skip,rows:c})},t),n()}).on("unpipe",function(){f.end()});l.on("error",t),l.pipe(f)})}),n._changes=function(e){function v(){e.done=!0,m&&e.limit&&e.limit<s.length&&(s.length=e.limit),y.unpipe(A),y.destroy(),e.continuous||e.cancelled||(e.include_docs&&e.attachments?fetchAttachments(s,i,e).then(function(){e.complete(null,{results:s,last_seq:u})}):e.complete(null,{results:s,last_seq:u}))}if(e=utils.clone(e),e.continuous){var t=o+":"+utils.uuid();return LevelPouch.Changes.addListener(o,t,n,e),LevelPouch.Changes.notify(o),{cancel:function(){LevelPouch.Changes.removeListener(o,t)}}}var f,r=e.descending,s=[],u=e.since||0,c=0,l={reverse:r};"limit"in e&&e.limit>0&&(f=e.limit),l.reverse||(l.start=g(e.since||0));var m,d=e.doc_ids&&new utils.Set(e.doc_ids),p=utils.filterChange(e),h=new utils.Map;m="returnDocs"in e?e.returnDocs:!0;var y=i.bySeqStore.readStream(l),A=through(function(t,n,o){function E(t){function r(n){var r=e.processChange(n,t,e);r.seq=t.seq,p(r)&&(c++,e.attachments&&e.include_docs?fetchAttachments([r],i,e).then(function(){e.onChange(r)}):e.onChange(r),m&&s.push(r)),o()}var n=merge.winningRev(t);if(t.seq!==l)return o();if(u=l,n===y._rev)return r(y);var a=t.rev_map[n];i.bySeqStore.get(g(a),function(e,t){r(t)})}if(f&&c>=f)return v(),o();if(e.cancelled||e.done)return o();var l=b(t.key),y=t.value;if(l===e.since&&!r)return o();if(d&&!d.has(y._id))return o();var A;return(A=h.get(y._id))?E(A):void i.docStore.get(y._id,function(t,n){return e.cancelled||e.done||a.isClosed()||isLocalId(n.id)?o():(h.set(y._id,n),void E(n))})},function(t){return e.cancelled?t():(m&&e.limit&&e.limit<s.length&&(s.length=e.limit),void t())}).on("unpipe",function(){A.end(),v()});return y.pipe(A),{cancel:function(){e.cancelled=!0,v()}}},n._close=function(e){return a.isClosed()?e(errors.error(errors.NOT_OPEN)):void a.close(function(t){t?e(t):(u["delete"](o),e())})},n._getRevisionTree=function(e,t){i.docStore.get(e,function(e,n){e?t(errors.error(errors.MISSING_DOC)):t(null,n.rev_tree)})},n._doCompaction=m(function(e,t,r,i){n._doCompactionNoLock(e,t,r,i)}),n._doCompactionNoLock=function(e,t,n,r){if("function"==typeof n&&(r=n,n={}),!t.length)return r();var o=n.ctx||new LevelTransaction;o.get(i.docStore,e,function(s,u){function h(e){if(e&&(p=e),++d===t.length){if(p)return r(p);v()}}function m(e){return e?r(e):(o.batch(l),n.ctx?r():void o.execute(a,r))}function v(){function s(e){e&&(a=e),++r===n.length&&m(a)}var n=Object.keys(f);if(!n.length)return m();var a,r=0,u=new utils.Map;t.forEach(function(t){u.set(e+"@"+t,!0)}),n.forEach(function(e){o.get(i.attachmentStore,e,function(t,n){if(t)return"NotFoundError"===t.name?s():s(t);var r=Object.keys(n.refs||{}).filter(function(e){return!u.has(e)}),a={};r.forEach(function(e){a[e]=!0}),r.length?l.push({key:e,type:"put",valueEncoding:"json",value:{refs:a},prefix:i.attachmentStore}):l=l.concat([{key:e,type:"del",prefix:i.attachmentStore},{key:e,type:"del",prefix:i.binaryStore}]),s()})})}if(s)return r(s);var c=u.rev_map;merge.traverseRevTree(u.rev_tree,function(e,n,r,i,a){var o=n+"-"+r;-1!==t.indexOf(o)&&(a.status="missing")});var l=[];l.push({key:u.id,value:u,type:"put",valueEncoding:safeJsonEncoding,prefix:i.docStore});var p,f={},d=0;t.forEach(function(e){var t=c[e];l.push({key:g(t),type:"del",prefix:i.bySeqStore}),o.get(i.bySeqStore,g(t),function(e,t){if(e)return"NotFoundError"===e.name?h():h(e);var n=Object.keys(t._attachments||{});n.forEach(function(e){var n=t._attachments[e].digest;f[n]=!0}),h()})})})},n._getLocal=function(e,t){i.localStore.get(e,function(e,n){e?t(errors.error(errors.MISSING_DOC)):t(null,n)})},n._putLocal=function(e,t,r){"function"==typeof t&&(r=t,t={}),t.ctx?n._putLocalNoLock(e,t,r):n._putLocalWithLock(e,t,r)},n._putLocalWithLock=m(function(e,t,r){n._putLocalNoLock(e,t,r)}),n._putLocalNoLock=function(e,t,n){delete e._revisions;var r=e._rev,o=e._id,s=t.ctx||new LevelTransaction;s.get(i.localStore,o,function(u,c){if(u&&r)return n(errors.error(errors.REV_CONFLICT));if(c&&c._rev!==r)return n(errors.error(errors.REV_CONFLICT));e._rev=r?"0-"+(parseInt(r.split("-")[1],10)+1):"0-1";var l=[{type:"put",prefix:i.localStore,key:o,value:e,valueEncoding:"json"}];s.batch(l);var f={ok:!0,id:e._id,rev:e._rev};return t.ctx?n(null,f):void s.execute(a,function(e){return e?n(e):void n(null,f)})})},n._removeLocal=function(e,t,r){"function"==typeof t&&(r=t,t={}),t.ctx?n._removeLocalNoLock(e,t,r):n._removeLocalWithLock(e,t,r)},n._removeLocalWithLock=m(function(e,t,r){n._removeLocalNoLock(e,t,r)}),n._removeLocalNoLock=function(e,t,n){var r=t.ctx||new LevelTransaction;r.get(i.localStore,e._id,function(o,s){if(o)return n("NotFoundError"!==o.name?o:errors.error(errors.MISSING_DOC));if(s._rev!==e._rev)return n(errors.error(errors.REV_CONFLICT));r.batch([{prefix:i.localStore,type:"del",key:e._id}]);var u={ok:!0,id:e._id,rev:"0-0"};return t.ctx?n(null,u):void r.execute(a,function(e){return e?n(e):void n(null,u)})})},n._destroy=function(e){var t;return dbStores.has(s.name)?(t=dbStores.get(s.name),void(t.has(o)?(LevelPouch.Changes.removeAllListeners(o),t.get(o).close(function(){t["delete"](o),y(o,e)})):y(o,e))):y(o,e)}}var levelup=require("levelup"),sublevel=require("level-sublevel"),through=require("through2").obj,originalLeveldown;requireLeveldown();var errors=require("../../deps/errors"),merge=require("../../merge"),utils=require("../../utils"),isDeleted=require("../../deps/docs/isDeleted"),isLocalId=require("../../deps/docs/isLocalId"),processDocs=require("../../deps/docs/processDocs"),md5=require("../../deps/md5"),migrate=require("../../deps/migrate"),Deque=require("double-ended-queue"),atob=require("../../deps/binary/base64").atob,btoa=require("../../deps/binary/base64").btoa,readAsBluffer=require("./readAsBlobOrBuffer"),prepareAttachmentForStorage=require("./prepareAttachmentForStorage"),createEmptyBluffer=require("./createEmptyBlobOrBuffer"),binStringToBluffer=require("../../deps/binary/binaryStringToBlobOrBuffer"),LevelTransaction=require("./transaction"),DOC_STORE="document-store",BY_SEQ_STORE="by-sequence",ATTACHMENT_STORE="attach-store",BINARY_STORE="attach-binary-store",LOCAL_STORE="local-store",META_STORE="meta-store",dbStores=new utils.Map,UPDATE_SEQ_KEY="_local_last_update_seq",DOC_COUNT_KEY="_local_doc_count",UUID_KEY="_local_uuid",MD5_PREFIX="md5-",safeJsonEncoding={encode:utils.safeJsonStringify,decode:utils.safeJsonParse,buffer:!1,type:"cheap-json"};LevelPouch.valid=function(){return!0},LevelPouch.use_prefix=!1,LevelPouch.Changes=new utils.Changes,module.exports=LevelPouch;
