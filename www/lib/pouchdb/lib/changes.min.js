"use strict";function Changes(e,t,n){function a(){r.cancel()}EE.call(this);var r=this;this.db=e,t=t?utils.clone(t):{};var i=t.complete=utils.once(function(t,n){t?r.emit("error",t):r.emit("complete",n),r.removeAllListeners(),e.removeListener("destroyed",a)});n&&(r.on("complete",function(e){n(null,e)}),r.on("error",function(e){n(e)})),e.once("destroyed",a),t.onChange=function(e){t.isCancelled||(r.emit("change",e),r.startSeq&&r.startSeq<=e.seq&&(r.startSeq=!1),e.deleted?r.emit("delete",e):1===e.changes.length&&"1-"===e.changes[0].rev.slice(0,2)?r.emit("create",e):r.emit("update",e))};var o=new utils.Promise(function(e,n){t.complete=function(t,r){t?n(t):e(r)}});r.once("cancel",function(){e.removeListener("destroyed",a),t.complete(null,{status:"cancelled"})}),this.then=o.then.bind(o),this["catch"]=o["catch"].bind(o),this.then(function(e){i(null,e)},i),e.taskqueue.isReady?r.doChanges(t):e.taskqueue.addTask(function(){r.isCancelled?r.emit("cancel"):r.doChanges(t)})}function processChange(e,t,n){var r=[{rev:e._rev}];"all_docs"===n.style&&(r=merge.collectLeaves(t.rev_tree).map(function(e){return{rev:e.rev}}));var i={id:t.id,changes:r,doc:e};return isDeleted(t,e._rev)&&(i.deleted=!0),n.conflicts&&(i.doc._conflicts=merge.collectConflicts(t),i.doc._conflicts.length||delete i.doc._conflicts),i}var utils=require("./utils"),isDeleted=require("./deps/docs/isDeleted"),merge=require("./merge"),errors=require("./deps/errors"),EE=require("events").EventEmitter,evalFilter=require("./evalFilter"),evalView=require("./evalView"),parseDdocFunctionName=require("./deps/docs/parseDdocFunctionName"),normalizeDdocFunctionName=require("./deps/docs/normalizeDdocFunctionName");module.exports=Changes,utils.inherits(Changes,EE),Changes.prototype.cancel=function(){this.isCancelled=!0,this.db.taskqueue.isReady&&this.emit("cancel")},Changes.prototype.doChanges=function(e){var t=this,n=e.complete;if(e=utils.clone(e),"live"in e&&!("continuous"in e)&&(e.continuous=e.live),e.processChange=processChange,"latest"===e.since&&(e.since="now"),e.since||(e.since=0),"now"===e.since)return void this.db.info().then(function(r){return t.isCancelled?void n(null,{status:"cancelled"}):(e.since=r.update_seq,void t.doChanges(e))},n);if(e.continuous&&"now"!==e.since&&this.db.info().then(function(e){t.startSeq=e.update_seq},function(e){if("idbNull"!==e.id)throw e}),e.filter&&"string"==typeof e.filter&&("_view"===e.filter?e.view=normalizeDdocFunctionName(e.view):e.filter=normalizeDdocFunctionName(e.filter),"http"!==this.db.type()&&!e.doc_ids))return this.filterChanges(e);"descending"in e||(e.descending=!1),e.limit=0===e.limit?1:e.limit,e.complete=n;var r=this.db._changes(e);if(r&&"function"==typeof r.cancel){var i=t.cancel;t.cancel=utils.getArguments(function(e){r.cancel(),i.apply(this,e)})}},Changes.prototype.filterChanges=function(e){var t=this,n=e.complete;if("_view"===e.filter){if(!e.view||"string"!=typeof e.view){var r=errors.error(errors.BAD_REQUEST,"`view` filter parameter not found or invalid.");return n(r)}var i=parseDdocFunctionName(e.view);this.db.get("_design/"+i[0],function(r,a){if(t.isCancelled)return n(null,{status:"cancelled"});if(r)return n(errors.generateErrorFromResponse(r));var o=a&&a.views&&a.views[i[1]]&&a.views[i[1]].map;return o?(e.filter=evalView(o),void t.doChanges(e)):n(errors.error(errors.MISSING_DOC,a.views?"missing json key: "+i[1]:"missing json key: views"))})}else{var a=parseDdocFunctionName(e.filter);if(!a)return n(errors.error(errors.BAD_REQUEST,"`filter` filter parameter invalid."));this.db.get("_design/"+a[0],function(r,i){if(t.isCancelled)return n(null,{status:"cancelled"});if(r)return n(errors.generateErrorFromResponse(r));var o=i&&i.filters&&i.filters[a[1]];return o?(e.filter=evalFilter(o),void t.doChanges(e)):n(errors.error(errors.MISSING_DOC,i&&i.filters?"missing json key: "+a[1]:"missing json key: filters"))})}};
