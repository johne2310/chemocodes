"use strict";function updateCheckpoint(e,t,n,r,i){return e.get(t)["catch"](function(n){if(404===n.status)return"http"===e.type()&&explain404("PouchDB is just checking if a remote checkpoint exists."),{session_id:r,_id:t,history:[],replicator:REPLICATOR,version:CHECKPOINT_VERSION};throw n}).then(function(a){return i.cancelled?void 0:(a.history=(a.history||[]).filter(function(e){return e.session_id!==r}),a.history.unshift({last_seq:n,session_id:r}),a.history=a.history.slice(0,CHECKPOINT_HISTORY_SIZE),a.version=CHECKPOINT_VERSION,a.replicator=REPLICATOR,a.session_id=r,a.last_seq=n,e.put(a)["catch"](function(a){if(409===a.status)return updateCheckpoint(e,t,n,r,i);throw a}))})}function Checkpointer(e,t,n,r){this.src=e,this.target=t,this.id=n,this.returnValue=r}function compareReplicationLogs(e,t){if(e.session_id===t.session_id)return{last_seq:e.last_seq,history:e.history||[]};var n=e.history||[],r=t.history||[];return compareReplicationHistory(n,r)}function compareReplicationHistory(e,t){var n=e[0],r=e.slice(1),i=t[0],a=t.slice(1);if(!n||0===t.length)return{last_seq:LOWEST_SEQ,history:[]};var o=n.session_id;if(hasSessionId(o,t))return{last_seq:n.last_seq,history:e};var s=i.session_id;return hasSessionId(s,r)?{last_seq:i.last_seq,history:a}:compareReplicationHistory(r,a)}function hasSessionId(e,t){var n=t[0],r=t.slice(1);return e&&0!==t.length?e===n.session_id?!0:hasSessionId(e,r):!1}var Promise=require("./../deps/promise"),explain404=require("./../deps/ajax/explain404"),pouchCollate=require("pouchdb-collate"),collate=pouchCollate.collate,CHECKPOINT_VERSION=1,REPLICATOR="pouchdb",CHECKPOINT_HISTORY_SIZE=5,LOWEST_SEQ=0;Checkpointer.prototype.writeCheckpoint=function(e,t){var n=this;return this.updateTarget(e,t).then(function(){return n.updateSource(e,t)})},Checkpointer.prototype.updateTarget=function(e,t){return updateCheckpoint(this.target,this.id,e,t,this.returnValue)},Checkpointer.prototype.updateSource=function(e,t){var n=this;return this.readOnlySource?Promise.resolve(!0):updateCheckpoint(this.src,this.id,e,t,this.returnValue)["catch"](function(e){var t="number"==typeof e.status&&4===Math.floor(e.status/100);if(t)return n.readOnlySource=!0,!0;throw e})};var comparisons={undefined:function(e,t){return 0===collate(e.last_seq,t.last_seq)?t.last_seq:0},1:function(e,t){return compareReplicationLogs(t,e).last_seq}};Checkpointer.prototype.getCheckpoint=function(){var e=this;return e.target.get(e.id).then(function(t){return e.src.get(e.id).then(function(e){if(t.version!==e.version)return LOWEST_SEQ;var n;return n=t.version?t.version.toString():"undefined",n in comparisons?comparisons[n](t,e):LOWEST_SEQ},function(n){if(404===n.status&&t.last_seq)return e.src.put({_id:e.id,last_seq:LOWEST_SEQ}).then(function(){return LOWEST_SEQ},function(n){return 401===n.status?(e.readOnlySource=!0,t.last_seq):LOWEST_SEQ});throw n})})["catch"](function(e){if(404!==e.status)throw e;return LOWEST_SEQ})},module.exports=Checkpointer;
