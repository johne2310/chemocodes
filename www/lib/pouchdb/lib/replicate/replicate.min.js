"use strict";function replicate(e,t,n,r,i){function S(){return y?utils.Promise.resolve():generateReplicationId(e,t,n).then(function(n){b=n,y=new Checkpointer(e,t,b,g)})}function k(){if(0!==o.docs.length){var e=o.docs;return t.bulkDocs({docs:e,new_edits:!1}).then(function(t){if(g.cancelled)throw O(),new Error("cancelled");var n=[],a={};t.forEach(function(e){e.error&&(i.doc_write_failures++,n.push(e),a[e.id]=e)}),A=A.concat(n),i.docs_written+=o.docs.length-n.length;var s=n.filter(function(e){return"unauthorized"!==e.name&&"forbidden"!==e.name});if(E=[],e.forEach(function(e){var t=a[e._id];t?r.emit("denied",utils.clone(t)):E.push(e)}),s.length>0){var u=new Error("bulkDocs error");throw u.other_errors=n,q("target.bulkDocs failed to write docs",u),new Error("bulkWrite partial failure")}},function(t){throw i.doc_write_failures+=e.length,t})}}function I(){return u=!0,y.writeCheckpoint(o.seq,w).then(function(){if(u=!1,g.cancelled)throw O(),new Error("cancelled");i.last_seq=f=o.seq;var e=utils.clone(i);e.docs=E,r.emit("change",e),o=void 0,L()})["catch"](function(e){throw u=!1,q("writeCheckpoint completed with error",e),e})}function C(){var e={};return o.changes.forEach(function(t){"_user/"!==t.id&&(e[t.id]=t.changes.map(function(e){return e.rev}))}),t.revsDiff(e).then(function(e){if(g.cancelled)throw O(),new Error("cancelled");o.diffs=e})}function B(){return getDocs(e,o.diffs,g).then(function(e){e.forEach(function(e){delete o.diffs[e._id],i.docs_read++,o.docs.push(e)})})}function _(){if(!g.cancelled&&!o){if(0===a.length)return void T(!0);o=a.shift(),C().then(B).then(k).then(I).then(_)["catch"](function(e){q("batch processing terminated with error",e)})}}function T(e){return 0===s.changes.length?void(0!==a.length||o||((d&&x.live||c)&&(r.state="pending",r.emit("paused")),c&&O())):void((e||c||s.changes.length>=p)&&(a.push(s),s={seq:0,changes:[],docs:[]},("pending"===r.state||"stopped"===r.state)&&(r.state="active",r.emit("active")),_()))}function q(e,t){l||(t.message||(t.message=e),i.ok=!1,i.status="aborting",i.errors.push(t),A=A.concat(t),a=[],s={seq:0,changes:[],docs:[]},O())}function O(){if(!(l||g.cancelled&&(i.status="cancelled",u))){i.status=i.status||"complete",i.end_time=new Date,i.last_seq=f,l=g.cancelled=!0;var a=A.filter(function(e){return"unauthorized"!==e.name&&"forbidden"!==e.name});if(a.length>0){var o=A.pop();A.length>0&&(o.other_errors=A),o.result=i,backOff(n,r,o,function(){replicate(e,t,n,r)})}else i.errors=A,r.emit("complete",i),r.removeAllListeners()}}function P(e){if(g.cancelled)return O();var t=utils.filterChange(n)(e);t&&(s.seq=e.seq,s.changes.push(e),T(0===a.length))}function D(e){return m=!1,g.cancelled?O():(e.results.length>0?(x.since=e.last_seq,L()):d?(x.live=!0,L()):c=!0,void T(!0))}function R(e){return m=!1,g.cancelled?O():void q("changes rejected",e)}function L(){function t(){o.cancel()}function i(){r.removeListener("cancel",t)}if(!m&&!c&&a.length<h){m=!0,r._changes&&(r.removeListener("cancel",r._abortChanges),r._changes.cancel()),r.once("cancel",t);var o=e.changes(x).on("change",P);o.then(i,i),o.then(D)["catch"](R),n.retry&&(r._changes=o,r._abortChanges=t)}}function j(){S().then(function(){return g.cancelled?void O():y.getCheckpoint().then(function(e){f=e,x={since:f,limit:p,batch_size:p,style:"all_docs",doc_ids:v,returnDocs:!0},n.filter&&("string"!=typeof n.filter?x.include_docs=!0:x.filter=n.filter),n.query_params&&(x.query_params=n.query_params),n.view&&(x.view=n.view),L()})})["catch"](function(e){q("getCheckpoint rejected with ",e)})}var o,b,y,a=[],s={seq:0,changes:[],docs:[]},u=!1,c=!1,l=!1,f=0,d=n.continuous||n.live||!1,p=n.batch_size||100,h=n.batches_limit||10,m=!1,v=n.doc_ids,g={cancelled:!1},A=[],E=[],w=utils.uuid();i=i||{ok:!0,start_time:new Date,docs_read:0,docs_written:0,doc_write_failures:0,errors:[]};var x={};return r.ready(e,t),r.cancelled?void O():(r._addedListeners||(r.once("cancel",O),"function"==typeof n.complete&&(r.once("error",n.complete),r.once("complete",function(e){n.complete(null,e)})),r._addedListeners=!0),void("undefined"==typeof n.since?j():S().then(function(){return u=!0,y.writeCheckpoint(n.since,w)}).then(function(){return u=!1,g.cancelled?void O():(f=n.since,void j())})["catch"](function(e){throw u=!1,q("writeCheckpoint completed with error",e),e})))}var utils=require("./../utils"),Checkpointer=require("./checkpointer"),backOff=require("./backoff"),generateReplicationId=require("./generateReplicationId"),getDocs=require("./getDocs");module.exports=replicate;
