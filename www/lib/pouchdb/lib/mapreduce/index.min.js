"use strict";function parseViewName(e){return-1===e.indexOf("/")?[e,e]:e.split("/")}function isGenOne(e){return 1===e.length&&/^1-/.test(e[0].rev)}function emitError(e,t){try{e.emit("error",t)}catch(n){console.error("The user's map/reduce function threw an uncaught error.\nYou can debug this error by doing:\nmyDatabase.on('error', function (err) { debugger; });\nPlease double-check your map/reduce function."),console.error(t)}}function tryCode(e,t,n){try{return{output:t.apply(null,n)}}catch(r){return emitError(e,r),{error:r}}}function sortByKeyThenValue(e,t){var n=collate(e.key,t.key);return 0!==n?n:collate(e.value,t.value)}function sliceResults(e,t,n){return n=n||0,"number"==typeof t?e.slice(n,t+n):n>0?e.slice(n):e}function rowToDocId(e){var t=e.value,n=t&&"object"==typeof t&&t._id||e.id;return n}function readAttachmentsAsBlobOrBuffer(e){e.rows.forEach(function(e){var t=e.doc&&e.doc._attachments;t&&Object.keys(t).forEach(function(e){var n=t[e];t[e].data=b64ToBluffer(n.data,n.content_type)})})}function postprocessAttachments(e){return function(t){return e.include_docs&&e.attachments&&e.binary&&readAttachmentsAsBlobOrBuffer(t),t}}function createBuiltInError(e){var t="builtin "+e+" function requires map values to be numbers or number arrays";return new BuiltInError(t)}function sum(e){for(var t=0,n=0,r=e.length;r>n;n++){var i=e[n];if("number"!=typeof i){if(!Array.isArray(i))throw createBuiltInError("_sum");t="number"==typeof t?[t]:t;for(var a=0,o=i.length;o>a;a++){var s=i[a];if("number"!=typeof s)throw createBuiltInError("_sum");"undefined"==typeof t[a]?t.push(s):t[a]+=s}}else"number"==typeof t?t+=i:t[0]+=i}return t}function addHttpParam(e,t,n,r){var i=t[e];"undefined"!=typeof i&&(r&&(i=encodeURIComponent(JSON.stringify(i))),n.push(e+"="+i))}function checkQueryParseError(e,t){var n=e.descending?"endkey":"startkey",r=e.descending?"startkey":"endkey";if("undefined"!=typeof e[n]&&"undefined"!=typeof e[r]&&collate(e[n],e[r])>0)throw new QueryParseError("No rows can match your key range, reverse your start_key and end_key or set {descending : true}");if(t.reduce&&e.reduce!==!1){if(e.include_docs)throw new QueryParseError("{include_docs:true} is invalid for reduce");if(e.keys&&e.keys.length>1&&!e.group&&!e.group_level)throw new QueryParseError("Multi-key fetches for reduce views must use {group: true}")}if(e.group_level){if("number"!=typeof e.group_level)throw new QueryParseError('Invalid value for integer: "'+e.group_level+'"');if(e.group_level<0)throw new QueryParseError('Invalid value for positive integer: "'+e.group_level+'"')}}function httpQuery(e,t,n){var i,r=[],a="GET";if(addHttpParam("reduce",n,r),addHttpParam("include_docs",n,r),addHttpParam("attachments",n,r),addHttpParam("limit",n,r),addHttpParam("descending",n,r),addHttpParam("group",n,r),addHttpParam("group_level",n,r),addHttpParam("skip",n,r),addHttpParam("stale",n,r),addHttpParam("conflicts",n,r),addHttpParam("startkey",n,r,!0),addHttpParam("endkey",n,r,!0),addHttpParam("inclusive_end",n,r),addHttpParam("key",n,r,!0),r=r.join("&"),r=""===r?"":"?"+r,"undefined"!=typeof n.keys){var o=2e3,s="keys="+encodeURIComponent(JSON.stringify(n.keys));s.length+r.length+1<=o?r+=("?"===r[0]?"&":"?")+s:(a="POST","string"==typeof t?i=JSON.stringify({keys:n.keys}):t.keys=n.keys)}if("string"==typeof t){var u=parseViewName(t);return e.request({method:a,url:"_design/"+u[0]+"/_view/"+u[1]+r,body:i}).then(postprocessAttachments(n))}return i=i||{},Object.keys(t).forEach(function(e){Array.isArray(t[e])?i[e]=t[e]:i[e]=t[e].toString()}),e.request({method:"POST",url:"_temp_view"+r,body:i}).then(postprocessAttachments(n))}function defaultsTo(e){return function(t){if(404===t.status)return e;throw t}}function getDocsToPersist(e,t,n){function u(){return isGenOne(s)?Promise.resolve(i):t.db.get(r)["catch"](defaultsTo(i))}function c(e){return e.keys.length?t.db.allDocs({keys:e.keys,include_docs:!0}):Promise.resolve({rows:[]})}function l(e,t){for(var n=[],r={},i=0,a=t.rows.length;a>i;i++){var s=t.rows[i],u=s.doc;if(u&&(n.push(u),r[u._id]=!0,u._deleted=!o[u._id],!u._deleted)){var c=o[u._id];"value"in c&&(u.value=c.value)}}var l=Object.keys(o);return l.forEach(function(e){if(!r[e]){var t={_id:e},i=o[e];"value"in i&&(t.value=i.value),n.push(t)}}),e.keys=utils.uniq(l.concat(e.keys)),n.push(e),n}var r="_local/doc_"+e,i={_id:r,keys:[]},a=n[e],o=a.indexableKeysToKeyValues,s=a.changes;return u().then(function(e){return c(e).then(function(t){return l(e,t)})})}function saveKeyValues(e,t,n){var r="_local/lastSeq";return e.db.get(r)["catch"](defaultsTo({_id:r,seq:0})).then(function(r){var i=Object.keys(t);return Promise.all(i.map(function(n){return getDocsToPersist(n,e,t)})).then(function(t){var i=utils.flatten(t);return r.seq=n,i.push(r),e.db.bulkDocs({docs:i})})})}function getQueue(e){var t="string"==typeof e?e:e.name,n=persistentQueues[t];return n||(n=persistentQueues[t]=new TaskQueue),n}function updateView(e){return utils.sequentialize(getQueue(e),function(){return updateViewInQueue(e)})()}function updateViewInQueue(e){function r(e,r){var i={id:n._id,key:normalizeKey(e)};"undefined"!=typeof r&&null!==r&&(i.value=normalizeKey(r)),t.push(i)}function s(t,n){return function(){return saveKeyValues(e,t,n)}}var t,n,i;if("function"==typeof e.mapFun&&2===e.mapFun.length){var a=e.mapFun;i=function(e){return a(e,r)}}else i=evalFunc(e.mapFun.toString(),r,sum,log,Array.isArray,JSON.parse);var o=e.seq||0,u=new TaskQueue;return new Promise(function(r,a){function c(){u.finish().then(function(){e.seq=o,r()})}function l(){function r(e){a(e)}e.sourceDB.changes({conflicts:!0,include_docs:!0,style:"all_docs",since:o,limit:CHANGES_BATCH_SIZE}).on("complete",function(r){var a=r.results;if(!a.length)return c();for(var f={},d=0,p=a.length;p>d;d++){var h=a[d];if("_"!==h.doc._id[0]){t=[],n=h.doc,n._deleted||tryCode(e.sourceDB,i,[n]),t.sort(sortByKeyThenValue);for(var v,m={},g=0,b=t.length;b>g;g++){var y=t[g],A=[y.key,y.id];0===collate(y.key,v)&&A.push(g);var E=toIndexableString(A);m[E]=y,v=y.key}f[h.doc._id]={indexableKeysToKeyValues:m,changes:h.changes}}o=h.seq}return u.add(s(f,o)),a.length<CHANGES_BATCH_SIZE?c():l()}).on("error",r)}l()})}function reduceView(e,t,n){0===n.group_level&&delete n.group_level;var i,r=n.group||n.group_level;i=builtInReduce[e.reduceFun]?builtInReduce[e.reduceFun]:evalFunc(e.reduceFun.toString(),null,sum,log,Array.isArray,JSON.parse);var a=[],o=n.group_level;t.forEach(function(e){var t=a[a.length-1],n=r?e.key:null;return r&&Array.isArray(n)&&"number"==typeof o&&(n=n.length>o?n.slice(0,o):n),t&&0===collate(t.key[0][0],n)?(t.key.push([n,e.id]),void t.value.push(e.value)):void a.push({key:[[n,e.id]],value:[e.value]})});for(var s=0,u=a.length;u>s;s++){var c=a[s],l=tryCode(e.sourceDB,i,[c.key,c.value,!1]);if(l.error&&l.error instanceof BuiltInError)throw l.error;c.value=l.error?null:l.output,c.key=c.key[0][0]}return{rows:sliceResults(a,n.limit,n.skip)}}function queryView(e,t){return utils.sequentialize(getQueue(e),function(){return queryViewInQueue(e,t)})()}function queryViewInQueue(e,t){function a(t){return t.include_docs=!0,e.db.allDocs(t).then(function(e){return n=e.total_rows,e.rows.map(function(e){if("value"in e.doc&&"object"==typeof e.doc.value&&null!==e.doc.value){var t=Object.keys(e.doc.value).sort(),n=["id","key","value"];if(!(n>t||t>n))return e.doc.value}var r=parseIndexableString(e.doc._id);return{key:r[0],id:r[1],value:"value"in e.doc?e.doc.value:null}})})}function o(a){var o;if(o=r?reduceView(e,a,t):{total_rows:n,offset:i,rows:a},t.include_docs){var s=utils.uniq(a.map(rowToDocId));return e.sourceDB.allDocs({keys:s,include_docs:!0,conflicts:t.conflicts,attachments:t.attachments,binary:t.binary}).then(function(e){var t={};return e.rows.forEach(function(e){e.doc&&(t["$"+e.id]=e.doc)}),a.forEach(function(e){var n=rowToDocId(e),r=t["$"+n];r&&(e.doc=r)}),o})}return o}var n,r=e.reduceFun&&t.reduce!==!1,i=t.skip||0;"undefined"==typeof t.keys||t.keys.length||(t.limit=0,delete t.keys);var s=function(e){return e.reduce(function(e,t){return e.concat(t)})};if("undefined"!=typeof t.keys){var u=t.keys,c=u.map(function(e){var t={startkey:toIndexableString([e]),endkey:toIndexableString([e,{}])};return a(t)});return Promise.all(c).then(s).then(o)}var l={descending:t.descending};if("undefined"!=typeof t.startkey&&(l.startkey=toIndexableString(t.descending?[t.startkey,{}]:[t.startkey])),"undefined"!=typeof t.endkey){var f=t.inclusive_end!==!1;t.descending&&(f=!f),l.endkey=toIndexableString(f?[t.endkey,{}]:[t.endkey])}if("undefined"!=typeof t.key){var d=toIndexableString([t.key]),p=toIndexableString([t.key,{}]);l.descending?(l.endkey=d,l.startkey=p):(l.startkey=d,l.endkey=p)}return r||("number"==typeof t.limit&&(l.limit=t.limit),l.skip=i),a(l).then(o)}function httpViewCleanup(e){return e.request({method:"POST",url:"_view_cleanup"})}function localViewCleanup(e){return e.get("_local/mrviews").then(function(t){var n={};Object.keys(t.views).forEach(function(e){var t=parseViewName(e),r="_design/"+t[0],i=t[1];n[r]=n[r]||{},n[r][i]=!0});var r={keys:Object.keys(n),include_docs:!0};return e.allDocs(r).then(function(r){var i={};r.rows.forEach(function(e){var r=e.key.substring(8);Object.keys(n[e.key]).forEach(function(n){var a=r+"/"+n;t.views[a]||(a=n);var o=Object.keys(t.views[a]),s=e.doc&&e.doc.views&&e.doc.views[n];o.forEach(function(e){i[e]=i[e]||s})})});var a=Object.keys(i).filter(function(e){return!i[e]}),o=a.map(function(t){return utils.sequentialize(getQueue(t),function(){return new e.constructor(t,e.__opts).destroy()})()});return Promise.all(o).then(function(){return{ok:!0}})})},defaultsTo({ok:!0}))}function queryPromised(e,t,n){if("http"===e.type())return httpQuery(e,t,n);if("string"!=typeof t){checkQueryParseError(n,t);var r={db:e,viewName:"temp_view/temp_view",map:t.map,reduce:t.reduce,temporary:!0};return tempViewQueue.add(function(){return createView(r).then(function(e){function t(){return e.db.destroy()}return utils.fin(updateView(e).then(function(){return queryView(e,n)}),t)})}),tempViewQueue.finish()}var i=t,a=parseViewName(i),o=a[0],s=a[1];return e.get("_design/"+o).then(function(t){var r=t.views&&t.views[s];if(!r||"string"!=typeof r.map)throw new NotFoundError("ddoc "+o+" has no view named "+s);checkQueryParseError(n,r);var a={db:e,viewName:i,map:r.map,reduce:r.reduce};return createView(a).then(function(e){return"ok"===n.stale||"update_after"===n.stale?("update_after"===n.stale&&process.nextTick(function(){updateView(e)}),queryView(e,n)):updateView(e).then(function(){return queryView(e,n)})})})}function QueryParseError(e){this.status=400,this.name="query_parse_error",this.message=e,this.error=!0;try{Error.captureStackTrace(this,QueryParseError)}catch(t){}}function NotFoundError(e){this.status=404,this.name="not_found",this.message=e,this.error=!0;try{Error.captureStackTrace(this,NotFoundError)}catch(t){}}function BuiltInError(e){this.status=500,this.name="invalid_value",this.message=e,this.error=!0;try{Error.captureStackTrace(this,BuiltInError)}catch(t){}}var b64ToBluffer=require("../deps/binary/base64StringToBlobOrBuffer"),pouchCollate=require("pouchdb-collate"),TaskQueue=require("./taskqueue"),collate=pouchCollate.collate,toIndexableString=pouchCollate.toIndexableString,normalizeKey=pouchCollate.normalizeKey,parseIndexableString=pouchCollate.parseIndexableString,createView=require("./create-view"),evalFunc=require("./evalfunc"),log;log="undefined"!=typeof console&&"function"==typeof console.log?Function.prototype.bind.call(console.log,console):function(){};var utils=require("./utils"),Promise=utils.Promise,persistentQueues={},tempViewQueue=new TaskQueue,CHANGES_BATCH_SIZE=50,builtInReduce={_sum:function(e,t){return sum(t)},_count:function(e,t){return t.length},_stats:function(e,t){function n(e){for(var t=0,n=0,r=e.length;r>n;n++){var i=e[n];t+=i*i}return t}return{sum:sum(t),min:Math.min.apply(null,t),max:Math.max.apply(null,t),count:t.length,sumsqr:n(t)}}};exports.viewCleanup=utils.callbackify(function(){var e=this;return"http"===e.type()?httpViewCleanup(e):localViewCleanup(e)}),exports.query=function(e,t,n){"function"==typeof t&&(n=t,t={}),t=utils.extend(!0,{},t),"function"==typeof e&&(e={map:e});var r=this,i=Promise.resolve().then(function(){return queryPromised(r,e,t)});return utils.promisedCallback(i,n),i},utils.inherits(QueryParseError,Error),utils.inherits(NotFoundError,Error),utils.inherits(BuiltInError,Error);
