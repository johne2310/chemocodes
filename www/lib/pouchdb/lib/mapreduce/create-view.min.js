"use strict";var upsert=require("./upsert"),utils=require("./utils"),Promise=utils.Promise;module.exports=function(e){var t=e.db,n=e.viewName,r=e.map,i=e.reduce,a=e.temporary,o=r.toString()+(i&&i.toString())+"undefined";if(!a&&t._cachedViews){var s=t._cachedViews[o];if(s)return Promise.resolve(s)}return t.info().then(function(e){function u(e){e.views=e.views||{};var t=n;-1===t.indexOf("/")&&(t=n+"/"+n);var r=e.views[t]=e.views[t]||{};if(!r[s])return r[s]=!0,e}var s=e.db_name+"-mrview-"+(a?"temp":utils.MD5(o));return upsert(t,"_local/mrviews",u).then(function(){return t.registerDependentDatabase(s).then(function(e){var n=e.db;n.auto_compaction=!0;var u={name:s,db:n,sourceDB:t,adapter:t.adapter,mapFun:r,reduceFun:i};return u.db.get("_local/lastSeq")["catch"](function(e){if(404!==e.status)throw e}).then(function(e){return u.seq=e?e.seq:0,a||(t._cachedViews=t._cachedViews||{},t._cachedViews[o]=u,u.db.once("destroyed",function(){delete t._cachedViews[o]})),u})})})})};
