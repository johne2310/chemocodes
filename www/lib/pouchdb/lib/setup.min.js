"use strict";function bindEventEmitterMethods(e){Object.keys(EE.prototype).forEach(function(t){"function"==typeof EE.prototype[t]&&(e[t]=eventEmitter[t].bind(eventEmitter))})}var PouchDB=require("./constructor"),utils=require("./utils"),EE=require("events").EventEmitter,hasLocalStorage=require("./deps/env/hasLocalStorage");PouchDB.adapters={},PouchDB.preferredAdapters=[],PouchDB.prefix="_pouch_";var eventEmitter=new EE;bindEventEmitterMethods(PouchDB),PouchDB.parseAdapter=function(e,t){var r,i,n=e.match(/([a-z\-]*):\/\/(.*)/);if(n){if(e=/http(s?)/.test(n[1])?n[1]+"://"+n[2]:n[2],r=n[1],!PouchDB.adapters[r].valid())throw"Invalid adapter";return{name:e,adapter:n[1]}}var a="idb"in PouchDB.adapters&&"websql"in PouchDB.adapters&&hasLocalStorage()&&localStorage["_pouch__websqldb_"+PouchDB.prefix+e];if(t.adapter)i=t.adapter;else if("undefined"!=typeof t&&t.db)i="leveldb";else for(var o=0;o<PouchDB.preferredAdapters.length;++o)if(i=PouchDB.preferredAdapters[o],i in PouchDB.adapters){if(a&&"idb"===i){console.log('PouchDB is downgrading "'+e+'" to WebSQL to avoid data loss, because it was already opened with WebSQL.');continue}break}r=PouchDB.adapters[i];var s=r&&"use_prefix"in r?r.use_prefix:!0;return{name:s?PouchDB.prefix+e:e,adapter:i}},PouchDB.destroy=utils.toPromise(function(e,t,n){console.log("PouchDB.destroy() is deprecated and will be removed. Please use db.destroy() instead."),("function"==typeof t||"undefined"==typeof t)&&(n=t,t={}),e&&"object"==typeof e&&(t=e,e=void 0),new PouchDB(e,t,function(e,t){return e?n(e):void t.destroy(n)})}),PouchDB.adapter=function(e,t,n){t.valid()&&(PouchDB.adapters[e]=t,n&&PouchDB.preferredAdapters.push(e))},PouchDB.plugin=function(e){return Object.keys(e).forEach(function(t){PouchDB.prototype[t]=e[t]}),PouchDB},PouchDB.defaults=function(e){function t(t,n,r){("function"==typeof n||"undefined"==typeof n)&&(r=n,n={}),t&&"object"==typeof t&&(n=t,t=void 0),n=utils.extend(!0,{},e,n),PouchDB.call(this,t,n,r)}return utils.inherits(t,PouchDB),t.destroy=utils.toPromise(function(t,n,r){return("function"==typeof n||"undefined"==typeof n)&&(r=n,n={}),t&&"object"==typeof t&&(n=t,t=void 0),n=utils.extend(!0,{},e,n),PouchDB.destroy(t,n,r)}),bindEventEmitterMethods(t),t.preferredAdapters=PouchDB.preferredAdapters.slice(),Object.keys(PouchDB).forEach(function(e){e in t||(t[e]=PouchDB[e])}),t},module.exports=PouchDB;
