"use strict";function preprocessAttachments(e,t,n){function i(e){try{return base64.atob(e)}catch(t){var n=errors.error(errors.BAD_ARG,"Attachments need to be base64 encoded");return{error:n}}}function a(e,n){if(e.stub)return n();if("string"==typeof e.data){var r=i(e.data);if(r.error)return n(r.error);e.length=r.length,"blob"===t?e.data=binStringToBlobOrBuffer(r,e.content_type):"base64"===t?e.data=base64.btoa(r):e.data=r,md5(r).then(function(t){e.digest="md5-"+t,n()})}else readAsArrayBuffer(e.data,function(r){"binary"===t?e.data=arrayBuffToBinString(r):"base64"===t&&(e.data=base64.btoa(arrayBuffToBinString(r))),md5(r).then(function(t){e.digest="md5-"+t,e.length=r.byteLength,n()})})}function s(){r++,e.length===r&&(o?n(o):n())}if(!e.length)return n();var o,r=0;e.forEach(function(e){function r(e){o=e,n++,n===t.length&&s()}var t=e.data&&e.data._attachments?Object.keys(e.data._attachments):[],n=0;if(!t.length)return s();for(var i in e.data._attachments)e.data._attachments.hasOwnProperty(i)&&a(e.data._attachments[i],r)})}var base64=require("../binary/base64"),arrayBuffToBinString=require("../binary/arrayBufferToBinaryString"),readAsArrayBuffer=require("../binary/readAsArrayBuffer"),binStringToBlobOrBuffer=require("../binary/binaryStringToBlobOrBuffer"),errors=require("../errors"),md5=require("../md5");module.exports=preprocessAttachments;
