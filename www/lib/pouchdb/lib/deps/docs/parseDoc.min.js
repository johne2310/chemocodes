"use strict";function toObject(e){return e.reduce(function(e,t){return e[t]=!0,e},{})}function parseRevisionInfo(e){if(!/^\d+\-./.test(e))return errors.error(errors.INVALID_REV);var t=e.indexOf("-"),n=e.substring(0,t),r=e.substring(t+1);return{prefix:parseInt(n,10),id:r}}function makeRevTreeFromRevisions(e,t){for(var n=e.start-e.ids.length+1,r=e.ids,i=[r[0],t,[]],a=1,o=r.length;o>a;a++)i=[r[a],{status:"missing"},[i]];return[{pos:n,ids:i}]}var errors=require("./../errors"),uuid=require("./../uuid"),reservedWords=toObject(["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats","_removed"]),dataWords=toObject(["_attachments","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats"]);exports.invalidIdError=function(e){var t;if(e?"string"!=typeof e?t=errors.error(errors.INVALID_ID):/^_/.test(e)&&!/^_(design|local)/.test(e)&&(t=errors.error(errors.RESERVED_ID)):t=errors.error(errors.MISSING_ID),t)throw t},exports.parseDoc=function(e,t){var n,r,i,a={status:"available"};if(e._deleted&&(a.deleted=!0),t)if(e._id||(e._id=uuid()),r=uuid(32,16).toLowerCase(),e._rev){if(i=parseRevisionInfo(e._rev),i.error)return i;e._rev_tree=[{pos:i.prefix,ids:[i.id,{status:"missing"},[[r,a,[]]]]}],n=i.prefix+1}else e._rev_tree=[{pos:1,ids:[r,a,[]]}],n=1;else if(e._revisions&&(e._rev_tree=makeRevTreeFromRevisions(e._revisions,a),n=e._revisions.start,r=e._revisions.ids[0]),!e._rev_tree){if(i=parseRevisionInfo(e._rev),i.error)return i;n=i.prefix,r=i.id,e._rev_tree=[{pos:n,ids:[r,a,[]]}]}exports.invalidIdError(e._id),e._rev=n+"-"+r;var o={metadata:{},data:{}};for(var s in e)if(e.hasOwnProperty(s)){var u="_"===s[0];if(u&&!reservedWords[s]){var c=errors.error(errors.DOC_VALIDATION,s);throw c.message=errors.DOC_VALIDATION.message+": "+s,c}u&&!dataWords[s]?o.metadata[s.slice(1)]=e[s]:o.data[s]=e[s]}return o};
