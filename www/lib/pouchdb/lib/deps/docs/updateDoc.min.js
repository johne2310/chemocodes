"use strict";function revExists(e,t){var n=!1;return merge.traverseRevTree(e.rev_tree,function(e,r,i){r+"-"+i===t&&(n=!0)}),n}function updateDoc(e,t,n,r,i,a,o){if(revExists(e,t.metadata.rev))return n[r]=t,i();var s=merge.winningRev(e),u=isDeleted(e,s),c=isDeleted(t.metadata),l=/^1-/.test(t.metadata.rev);if(u&&!c&&o&&l){var f=t.data;f._rev=s,f._id=t.metadata.id,t=parseDoc(f,o)}var d=merge.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),p=o&&(u&&c||!u&&"new_leaf"!==d.conflicts||u&&!c&&"new_branch"===d.conflicts);if(p){var h=errors.error(errors.REV_CONFLICT);return n[r]=h,i()}var m=t.metadata.rev;t.metadata.rev_tree=d.tree,e.rev_map&&(t.metadata.rev_map=e.rev_map);var v=merge.winningRev(t.metadata),g=isDeleted(t.metadata,v),b=u===g?0:g>u?-1:1,y=isDeleted(t.metadata,m);a(t,v,g,y,!0,b,r,i)}var merge=require("../../merge"),errors=require("../errors"),isDeleted=require("./isDeleted"),parseDoc=require("./parseDoc").parseDoc;module.exports=updateDoc;
