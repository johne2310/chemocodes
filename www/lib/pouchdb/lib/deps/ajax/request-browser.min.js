"use strict";function wrappedFetch(){for(var e={},t=new utils.Promise(function(t,n){e.resolve=t,e.reject=n}),n=new Array(arguments.length),r=0;r<n.length;r++)n[r]=arguments[r];return e.promise=t,utils.Promise.resolve().then(function(){return fetch.apply(null,n)}).then(function(t){e.resolve(t)})["catch"](function(t){e.reject(t)}),e}function fetchRequest(e,t){var n,r,i,a=new Headers,o={method:e.method,credentials:"include",headers:a};return e.json&&(a.set("Accept","application/json"),a.set("Content-Type",e.headers["Content-Type"]||"application/json")),e.body&&e.body instanceof Blob?readAsArrayBuffer(e.body,function(e){o.body=e}):e.body&&e.processData&&"string"!=typeof e.body?o.body=JSON.stringify(e.body):"body"in e?o.body=e.body:o.body=null,Object.keys(e.headers).forEach(function(t){e.headers.hasOwnProperty(t)&&a.set(t,e.headers[t])}),n=wrappedFetch(e.url,o),e.timeout>0&&(r=setTimeout(function(){n.reject(new Error("Load timeout for resource: "+e.url))},e.timeout)),n.promise.then(function(t){return i={statusCode:t.status},e.timeout>0&&clearTimeout(r),i.statusCode>=200&&i.statusCode<300?e.binary?t.blob():t.text():t.json()}).then(function(e){i.statusCode>=200&&i.statusCode<300?t(null,i,e):t(e,i)})["catch"](function(e){t(e,i)}),{abort:n.reject}}function xhRequest(e,t){var n,r,i,a=function(){n.abort()};n=e.xhr?new e.xhr:new XMLHttpRequest,n.open(e.method,e.url),n.withCredentials=!0,"GET"===e.method?delete e.headers["Content-Type"]:e.json&&(e.headers.Accept="application/json",e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.body&&e.processData&&"string"!=typeof e.body&&(e.body=JSON.stringify(e.body))),e.binary&&(n.responseType="arraybuffer"),"body"in e||(e.body=null);for(var o in e.headers)e.headers.hasOwnProperty(o)&&n.setRequestHeader(o,e.headers[o]);return e.timeout>0&&(r=setTimeout(a,e.timeout),n.onprogress=function(){clearTimeout(r),r=setTimeout(a,e.timeout)},"undefined"==typeof i&&(i=-1!==Object.keys(n).indexOf("upload")&&"undefined"!=typeof n.upload),i&&(n.upload.onprogress=n.onprogress)),n.onreadystatechange=function(){if(4===n.readyState){var r={statusCode:n.status};if(n.status>=200&&n.status<300){var i;i=e.binary?createBlob([n.response||""],{type:n.getResponseHeader("Content-Type")}):n.responseText,t(null,r,i)}else{var a={};try{a=JSON.parse(n.response)}catch(o){}t(a,r)}}},e.body&&e.body instanceof Blob?readAsArrayBuffer(e.body,function(e){n.send(e)}):n.send(e.body),{abort:a}}function testXhr(){try{return new XMLHttpRequest,!0}catch(e){return!1}}var createBlob=require("./../binary/blob.js"),utils=require("../../utils"),readAsArrayBuffer=require("./../binary/readAsArrayBuffer"),hasXhr=testXhr();module.exports=function(e,t){return hasXhr||e.xhr?xhRequest(e,t):fetchRequest(e,t)};
