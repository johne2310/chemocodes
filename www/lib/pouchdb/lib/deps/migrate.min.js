"use strict";function formatSeq(e){return("0000000000000000"+e).slice(-16)}var fs=require("fs"),path=require("path"),isLocalId=require("./docs/isLocalId"),merge=require("../merge"),levelup=require("levelup"),through=require("through2").obj,stores=["document-store","by-sequence","attach-store","attach-binary-store"],UPDATE_SEQ_KEY="_local_last_update_seq",DOC_COUNT_KEY="_local_doc_count",UUID_KEY="_local_uuid";exports.toSublevel=function(e,t,n){function a(e,n,r){var o,a=path.join(i,e);o=3===n?{valueEncoding:"binary"}:{valueEncoding:"json"};var s=t.sublevel(e,o),u=levelup(a,o),c=u.createReadStream(),l=s.createWriteStream();c.on("end",function(){u.close(function(e){r(e,a)})}),c.pipe(l)}var r=require("leveldown"),i=path.resolve(e);fs.unlink(i+".uuid",function(e){if(e)return n();var t=4,o=[];stores.forEach(function(e,s){a(e,s,function(e,a){return e?n(e):(o.push(a),void(--t||o.forEach(function(e){r.destroy(e,function(){++t===o.length&&fs.rmdir(i,n)})})))})})})},exports.localAndMetaStores=function(e,t,n){var r=[];t.bySeqStore.get(UUID_KEY,function(i,a){return i?n():(r.push({key:UUID_KEY,value:a,prefix:t.metaStore,type:"put",valueEncoding:"json"}),r.push({key:UUID_KEY,prefix:t.bySeqStore,type:"del"}),void t.bySeqStore.get(DOC_COUNT_KEY,function(i,a){a&&(r.push({key:DOC_COUNT_KEY,value:a,prefix:t.metaStore,type:"put",valueEncoding:"json"}),r.push({key:DOC_COUNT_KEY,prefix:t.bySeqStore,type:"del"})),t.bySeqStore.get(UPDATE_SEQ_KEY,function(i,a){a&&(r.push({key:UPDATE_SEQ_KEY,value:a,prefix:t.metaStore,type:"put",valueEncoding:"json"}),r.push({key:UPDATE_SEQ_KEY,prefix:t.bySeqStore,type:"del"}));var o={};t.docStore.createReadStream({startKey:"_",endKey:"_Ã¿"}).pipe(through(function(e,n,i){if(!isLocalId(e.key))return i();r.push({key:e.key,prefix:t.docStore,type:"del"});var a=merge.winningRev(e.value);Object.keys(e.value.rev_map).forEach(function(t){"winner"!==t&&this.push(formatSeq(e.value.rev_map[t]))},this);var o=e.value.rev_map[a];t.bySeqStore.get(formatSeq(o),function(n,a){n||r.push({key:e.key,value:a,prefix:t.localStore,type:"put",valueEncoding:"json"}),i()})})).pipe(through(function(e,n,i){return o[e]?i():(o[e]=!0,void t.bySeqStore.get(e,function(n,a){return n||!isLocalId(a._id)?i():(r.push({key:e,prefix:t.bySeqStore,type:"del"}),void i())}))},function(t){e.batch(r,n)}))})}))})};
