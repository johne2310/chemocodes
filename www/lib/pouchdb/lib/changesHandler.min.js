"use strict";function attachBrowserEvents(e){isChromeApp()?chrome.storage.onChanged.addListener(function(t){null!=t.db_name&&e.emit(t.dbName.newValue)}):hasLocalStorage()&&("undefined"!=typeof addEventListener?addEventListener("storage",function(t){e.emit(t.key)}):window.attachEvent("storage",function(t){e.emit(t.key)}))}function Changes(){EventEmitter.call(this),this._listeners={},attachBrowserEvents(this)}var EventEmitter=require("events").EventEmitter,inherits=require("inherits"),isChromeApp=require("./deps/env/isChromeApp"),hasLocalStorage=require("./deps/env/hasLocalStorage"),pick=require("./deps/pick"),call=require("./deps/call");inherits(Changes,EventEmitter),Changes.prototype.addListener=function(e,t,n,r){function o(){if(i._listeners[t]){if(a)return void(a="waiting");a=!0;var e=pick(r,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary"]);n.changes(e).on("change",function(e){e.seq>r.since&&!r.cancelled&&(r.since=e.seq,call(r.onChange,e))}).on("complete",function(){"waiting"===a&&setTimeout(function(){o()},0),a=!1}).on("error",function(){a=!1})}}if(!this._listeners[t]){var i=this,a=!1;this._listeners[t]=o,this.on(e,o)}},Changes.prototype.removeListener=function(e,t){t in this._listeners&&EventEmitter.prototype.removeListener.call(this,e,this._listeners[t])},Changes.prototype.notifyLocalWindows=function(e){isChromeApp()?chrome.storage.local.set({dbName:e}):hasLocalStorage()&&(localStorage[e]="a"===localStorage[e]?"b":"a")},Changes.prototype.notify=function(e){this.emit(e),this.notifyLocalWindows(e)},module.exports=Changes;
