"use strict";function arrayFirst(e,t){for(var n=0;n<e.length;n++)if(t(e[n],n)===!0)return e[n];return!1}function yankError(e){return function(t,n){t||n[0]&&n[0].error?e(t||n[0]):e(null,n.length?n[0]:n)}}function cleanDocs(e){for(var t=0;t<e.length;t++){var n=e[t];if(n._deleted)delete n._attachments;else if(n._attachments)for(var r=Object.keys(n._attachments),i=0;i<r.length;i++){var a=r[i];n._attachments[a]=utils.pick(n._attachments[a],["data","digest","content_type","length","revpos","stub"])}}}function compareByIdThenRev(e,t){var n=utils.compare(e._id,t._id);if(0!==n)return n;var r=e._revisions?e._revisions.start:0,i=t._revisions?t._revisions.start:0;return utils.compare(r,i)}function computeHeight(e){var t={},n=[];return merge.traverseRevTree(e,function(e,r,i,a){var o=r+"-"+i;return e&&(t[o]=0),void 0!==a&&n.push({from:a,to:o}),o}),n.reverse(),n.forEach(function(e){void 0===t[e.from]?t[e.from]=1+t[e.to]:t[e.from]=Math.min(t[e.from],1+t[e.to])}),t}function allDocsKeysQuery(e,t,n){var r="limit"in t?t.keys.slice(t.skip,t.limit+t.skip):t.skip>0?t.keys.slice(t.skip):t.keys;if(t.descending&&r.reverse(),!r.length)return e._allDocs({limit:0},n);var i={offset:t.skip};return Promise.all(r.map(function(n){var r=utils.extend(!0,{key:n,deleted:"ok"},t);return["limit","skip","keys"].forEach(function(e){delete r[e]}),new Promise(function(t,a){e._allDocs(r,function(e,r){return e?a(e):(i.total_rows=r.total_rows,void t(r.rows[0]||{key:n,error:"not_found"}))})})})).then(function(e){return i.rows=e,i})}function doNextCompaction(e){var t=e._compactionQueue[0],n=t.opts,r=t.callback;e.get("_local/compaction")["catch"](function(){return!1}).then(function(t){t&&t.last_seq&&(n.last_seq=t.last_seq),e._compact(n,function(t,n){t?r(t):r(null,n),process.nextTick(function(){e._compactionQueue.shift(),e._compactionQueue.length&&doNextCompaction(e)})})})}function AbstractPouchDB(){EventEmitter.call(this)}var utils=require("./utils"),merge=require("./merge"),errors=require("./deps/errors"),EventEmitter=require("events").EventEmitter,upsert=require("./deps/upsert"),Changes=require("./changes"),Promise=utils.Promise,isDeleted=require("./deps/docs/isDeleted"),isLocalId=require("./deps/docs/isLocalId");utils.inherits(AbstractPouchDB,EventEmitter),module.exports=AbstractPouchDB,AbstractPouchDB.prototype.post=utils.adapterFun("post",function(e,t,n){return"function"==typeof t&&(n=t,t={}),"object"!=typeof e||Array.isArray(e)?n(errors.error(errors.NOT_AN_OBJECT)):void this.bulkDocs({docs:[e]},t,yankError(n))}),AbstractPouchDB.prototype.put=utils.adapterFun("put",utils.getArguments(function(e){var t,n,r,i,a=e.shift(),o="_id"in a;if("object"!=typeof a||Array.isArray(a))return(i=e.pop())(errors.error(errors.NOT_AN_OBJECT));for(a=utils.clone(a);;)if(t=e.shift(),n=typeof t,"string"!==n||o?"string"!==n||!o||"_rev"in a?"object"===n?r=t:"function"===n&&(i=t):a._rev=t:(a._id=t,o=!0),!e.length)break;r=r||{};var s=utils.invalidIdError(a._id);return s?i(s):isLocalId(a._id)&&"function"==typeof this._putLocal?a._deleted?this._removeLocal(a,i):this._putLocal(a,i):void this.bulkDocs({docs:[a]},r,yankError(i))})),AbstractPouchDB.prototype.putAttachment=utils.adapterFun("putAttachment",function(e,t,n,r,i,a){function s(e){return e._attachments=e._attachments||{},e._attachments[t]={content_type:i,data:r},o.put(e)}var o=this;return"function"==typeof i&&(a=i,i=r,r=n,n=null),"undefined"==typeof i&&(i=r,r=n,n=null),o.get(e).then(function(e){if(e._rev!==n)throw errors.error(errors.REV_CONFLICT);return s(e)},function(t){if(t.reason===errors.MISSING_DOC.message)return s({_id:e});throw t})}),AbstractPouchDB.prototype.removeAttachment=utils.adapterFun("removeAttachment",function(e,t,n,r){var i=this;i.get(e,function(e,a){return e?void r(e):a._rev!==n?void r(errors.error(errors.REV_CONFLICT)):a._attachments?(delete a._attachments[t],0===Object.keys(a._attachments).length&&delete a._attachments,void i.put(a,r)):r()})}),AbstractPouchDB.prototype.remove=utils.adapterFun("remove",function(e,t,n,r){var i;"string"==typeof t?(i={_id:e,_rev:t},"function"==typeof n&&(r=n,n={})):(i=e,"function"==typeof t?(r=t,n={}):(r=n,n=t)),n=utils.clone(n||{}),n.was_delete=!0;var a={_id:i._id,_rev:i._rev||n.rev};return a._deleted=!0,isLocalId(a._id)&&"function"==typeof this._removeLocal?this._removeLocal(i,r):void this.bulkDocs({docs:[a]},n,yankError(r))}),AbstractPouchDB.prototype.revsDiff=utils.adapterFun("revsDiff",function(e,t,n){function o(e,t){a.has(e)||a.set(e,{missing:[]}),a.get(e).missing.push(t)}function s(t,n){var r=e[t].slice(0);merge.traverseRevTree(n,function(e,n,i,a,s){var u=n+"-"+i,c=r.indexOf(u);-1!==c&&(r.splice(c,1),"available"!==s.status&&o(t,u))}),r.forEach(function(e){o(t,e)})}"function"==typeof t&&(n=t,t={}),t=utils.clone(t);var r=Object.keys(e);if(!r.length)return n(null,{});var i=0,a=new utils.Map;r.map(function(t){this._getRevisionTree(t,function(o,u){if(o&&404===o.status&&"missing"===o.message)a.set(t,{missing:e[t]});else{if(o)return n(o);s(t,u)}if(++i===r.length){var c={};return a.forEach(function(e,t){c[t]=e}),n(null,c)}})},this)}),AbstractPouchDB.prototype.compactDocument=utils.adapterFun("compactDocument",function(e,t,n){var r=this;this._getRevisionTree(e,function(i,a){if(i)return n(i);var o=computeHeight(a),s=[],u=[];Object.keys(o).forEach(function(e){o[e]>t&&s.push(e)}),merge.traverseRevTree(a,function(e,t,n,r,i){var a=t+"-"+n;"available"===i.status&&-1!==s.indexOf(a)&&u.push(a)}),r._doCompaction(e,u,n)})}),AbstractPouchDB.prototype.compact=utils.adapterFun("compact",function(e,t){"function"==typeof e&&(t=e,e={});var n=this;e=utils.clone(e||{}),n._compactionQueue=n._compactionQueue||[],n._compactionQueue.push({opts:e,callback:t}),1===n._compactionQueue.length&&doNextCompaction(n)}),AbstractPouchDB.prototype._compact=function(e,t){function a(e){i.push(n.compactDocument(e.id,0))}function o(e){var r=e.last_seq;Promise.all(i).then(function(){return upsert(n,"_local/compaction",function(e){return!e.last_seq||e.last_seq<r?(e.last_seq=r,e):!1})}).then(function(){t(null,{ok:!0})})["catch"](t)}var n=this,r={returnDocs:!1,last_seq:e.last_seq||0},i=[];n.changes(r).on("change",a).on("complete",o).on("error",t)},AbstractPouchDB.prototype.get=utils.adapterFun("get",function(e,t,n){function a(){var a=[],o=r.length;return o?void r.forEach(function(r){i.get(e,{rev:r,revs:t.revs,attachments:t.attachments},function(e,t){e?a.push({missing:r}):a.push({ok:t}),o--,o||n(null,a)})}):n(null,a)}if("function"==typeof t&&(n=t,t={}),"string"!=typeof e)return n(errors.error(errors.INVALID_ID));if(isLocalId(e)&&"function"==typeof this._getLocal)return this._getLocal(e,n);var r=[],i=this;if(!t.open_revs)return this._get(e,t,function(e,r){if(t=utils.clone(t),e)return n(e);var a=r.doc,o=r.metadata,s=r.ctx;if(t.conflicts){var u=merge.collectConflicts(o);u.length&&(a._conflicts=u)}if(isDeleted(o,a._rev)&&(a._deleted=!0),t.revs||t.revs_info){var c=merge.rootToLeaf(o.rev_tree),l=arrayFirst(c,function(e){return-1!==e.ids.map(function(e){return e.id}).indexOf(a._rev.split("-")[1])}),f=l.ids.map(function(e){return e.id}).indexOf(a._rev.split("-")[1])+1,d=l.ids.length-f;if(l.ids.splice(f,d),l.ids.reverse(),t.revs&&(a._revisions={start:l.pos+l.ids.length-1,ids:l.ids.map(function(e){return e.id})}),t.revs_info){var p=l.pos+l.ids.length;a._revs_info=l.ids.map(function(e){return p--,{rev:p+"-"+e.id,status:e.opts.status}})}}if(t.attachments&&a._attachments){var h=a._attachments,m=Object.keys(h).length;if(0===m)return n(null,a);Object.keys(h).forEach(function(e){this._getAttachment(h[e],{binary:t.binary,ctx:s},function(t,r){var i=a._attachments[e];i.data=r,delete i.stub,delete i.length,--m||n(null,a)})},i)}else{if(a._attachments)for(var v in a._attachments)a._attachments.hasOwnProperty(v)&&(a._attachments[v].stub=!0);n(null,a)}});if("all"===t.open_revs)this._getRevisionTree(e,function(e,t){return e?n(e):(r=merge.collectLeaves(t).map(function(e){return e.rev}),void a())});else{if(!Array.isArray(t.open_revs))return n(errors.error(errors.UNKNOWN_ERROR,"function_clause"));r=t.open_revs;for(var o=0;o<r.length;o++){var s=r[o];if("string"!=typeof s||!/^\d+-/.test(s))return n(errors.error(errors.INVALID_REV))}a()}}),AbstractPouchDB.prototype.getAttachment=utils.adapterFun("getAttachment",function(e,t,n,r){var i=this;n instanceof Function&&(r=n,n={}),n=utils.clone(n),this._get(e,n,function(e,a){return e?r(e):a.doc._attachments&&a.doc._attachments[t]?(n.ctx=a.ctx,n.binary=!0,i._getAttachment(a.doc._attachments[t],n,r),void 0):r(errors.error(errors.MISSING_DOC))})}),AbstractPouchDB.prototype.allDocs=utils.adapterFun("allDocs",function(e,t){if("function"==typeof e&&(t=e,e={}),e=utils.clone(e),e.skip="undefined"!=typeof e.skip?e.skip:0,"keys"in e){if(!Array.isArray(e.keys))return t(new TypeError("options.keys must be an array"));var n=["startkey","endkey","key"].filter(function(t){return t in e})[0];if(n)return void t(errors.error(errors.QUERY_PARSE_ERROR,"Query parameter `"+n+"` is not compatible with multi-get"));if("http"!==this.type())return allDocsKeysQuery(this,e,t)}return this._allDocs(e,t)}),AbstractPouchDB.prototype.changes=function(e,t){return"function"==typeof e&&(t=e,e={}),new Changes(this,e,t)},AbstractPouchDB.prototype.close=utils.adapterFun("close",function(e){return this._closed=!0,this._close(e)}),AbstractPouchDB.prototype.info=utils.adapterFun("info",function(e){var t=this;this._info(function(n,r){return n?e(n):(r.db_name=r.db_name||t._db_name,r.auto_compaction=!(!t.auto_compaction||"http"===t.type()),r.adapter=t.type(),void e(null,r))})}),AbstractPouchDB.prototype.id=utils.adapterFun("id",function(e){return this._id(e)}),AbstractPouchDB.prototype.type=function(){return"function"==typeof this._type?this._type():this.adapter},AbstractPouchDB.prototype.bulkDocs=utils.adapterFun("bulkDocs",function(e,t,n){if("function"==typeof t&&(n=t,t={}),t=utils.clone(t),Array.isArray(e)&&(e={docs:e}),!e||!e.docs||!Array.isArray(e.docs))return n(errors.error(errors.MISSING_BULK_DOCS));for(var r=0;r<e.docs.length;++r)if("object"!=typeof e.docs[r]||Array.isArray(e.docs[r]))return n(errors.error(errors.NOT_AN_OBJECT));return e=utils.clone(e),"new_edits"in t||("new_edits"in e?t.new_edits=e.new_edits:t.new_edits=!0),t.new_edits||"http"===this.type()||e.docs.sort(compareByIdThenRev),cleanDocs(e.docs),this._bulkDocs(e,t,function(e,r){return e?n(e):(t.new_edits||(r=r.filter(function(e){return e.error})),void n(null,r))})}),AbstractPouchDB.prototype.registerDependentDatabase=utils.adapterFun("registerDependentDatabase",function(e,t){function r(t){return t.dependentDbs=t.dependentDbs||{},t.dependentDbs[e]?!1:(t.dependentDbs[e]=!0,t)}var n=new this.constructor(e,this.__opts);upsert(this,"_local/_pouch_dependentDbs",r,function(e){return e?t(e):t(null,{db:n})})}),AbstractPouchDB.prototype.destroy=utils.adapterFun("destroy",function(e){function r(){t._destroy(function(n,r){return n?e(n):(t.emit("destroyed"),void e(null,r||{ok:!0}))})}var t=this,n="use_prefix"in t?t.use_prefix:!0;t.get("_local/_pouch_dependentDbs",function(i,a){if(i)return 404!==i.status?e(i):r();var o=a.dependentDbs,s=t.constructor,u=Object.keys(o).map(function(e){var r=n?e.replace(new RegExp("^"+s.prefix),""):e;return new s(r,t.__opts).destroy()});Promise.all(u).then(r,function(t){e(t)})})});
