"use strict";function sync(e,t,n,r){return"function"==typeof n&&(r=n,n={}),"undefined"==typeof n&&(n={}),n=utils.clone(n),n.PouchConstructor=n.PouchConstructor||this,e=replication.toPouch(e,n),t=replication.toPouch(t,n),new Sync(e,t,n,r)}function Sync(e,t,n,r){function o(e){a||(a=!0,i.emit("cancel",e))}function s(e){i.emit("change",{direction:"pull",change:e})}function u(e){i.emit("change",{direction:"push",change:e})}function c(e){i.emit("denied",{direction:"push",doc:e})}function l(e){i.emit("denied",{direction:"pull",doc:e})}function p(e){return function(t,n){var r="change"===t&&(n===s||n===u),a="cancel"===t&&n===o,c=t in f&&n===f[t];(r||a||c)&&(t in d||(d[t]={}),d[t][e]=!0,2===Object.keys(d[t]).length&&i.removeAllListeners(t))}}var i=this;this.canceled=!1,this.push=replicate(e,t,n),this.pull=replicate(t,e,n);var a=!1,f={},d={};n.live&&(this.push.on("complete",i.pull.cancel.bind(i.pull)),this.pull.on("complete",i.push.cancel.bind(i.push))),this.on("newListener",function(e){"change"===e?(i.pull.on("change",s),i.push.on("change",u)):"denied"===e?(i.pull.on("denied",l),i.push.on("denied",c)):"cancel"===e?(i.pull.on("cancel",o),i.push.on("cancel",o)):"error"===e||"removeListener"===e||"complete"===e||e in f||(f[e]=function(t){i.emit(e,t)},i.pull.on(e,f[e]),i.push.on(e,f[e]))}),this.on("removeListener",function(e){"change"===e?(i.pull.removeListener("change",s),i.push.removeListener("change",u)):"cancel"===e?(i.pull.removeListener("cancel",o),i.push.removeListener("cancel",o)):e in f&&"function"==typeof f[e]&&(i.pull.removeListener(e,f[e]),i.push.removeListener(e,f[e]),delete f[e])}),this.pull.on("removeListener",p("pull")),this.push.on("removeListener",p("push"));var h=utils.Promise.all([this.push,this.pull]).then(function(e){var t={push:e[0],pull:e[1]};return i.emit("complete",t),r&&r(null,t),i.removeAllListeners(),t},function(e){throw i.cancel(),i.emit("error",e),r&&r(e),i.removeAllListeners(),e});this.then=function(e,t){return h.then(e,t)},this["catch"]=function(e){return h["catch"](e)}}var utils=require("./utils"),replication=require("./replicate"),replicate=replication.replicate,EE=require("events").EventEmitter;utils.inherits(Sync,EE),module.exports=sync,Sync.prototype.cancel=function(){this.canceled||(this.canceled=!0,this.push.cancel(),this.pull.cancel())};
